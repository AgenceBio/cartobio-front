<route lang="yaml">
meta:
requiresAuth: true
seo:
title: Parcellaire
</route>

<template>
  <main class="fr-container fr-py-2w">
    <nav role="navigation" class="fr-breadcrumb">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li><a class="fr-breadcrumb__link" aria-current="page">{{ operatorStore.operator.nom }}</a></li>
      </ol>
    </nav>

    <div class="header">
      <h3>
        {{ operatorStore.operator.nom }}
      </h3>
      <button v-if="permissions.canCreateVersion" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line" @click="newVersionModal = true">
        Créer une nouvelle version
      </button>
    </div>

    <OperatorSetupFlow
        v-if="operatorStore.records && !operatorStore.records.length"
        :operator="operatorStore.operator"
        :actions="operatorSetupActions"
        :with-stepper="permissions.isAgri"
        @redirect="$router.push(`/exploitations/${operatorStore.operator.numeroBio}/${$event.record_id}`)"
    >
      <template #introduction>
        <p class="fr-text--lead" v-if="permissions.isOc">Importer un parcellaire d'exploitation agricole.</p>

        <p class="fr-text--lg" v-if="permissions.isAgri">
          Nous vous demandons quelques informations lors
          d'une <em>première utilisation</em> de CartoBio.
        </p>
        <p class="fr-h6" v-if="permissions.isAgri">
          Choisir votre mode de création de parcellaire :
        </p>
      </template>
    </OperatorSetupFlow>

    <div v-else class="fr-table fr-table--bordered version-table">
      <table aria-hidden="true">
        <colgroup>
          <col class="blank-column"/>
          <col class="version-name"/>
          <col class="audit-date"/>
          <col class="surface"/>
          <col class="parcelles"/>
          <col class="statut"/>
          <col class="actions"/>
        </colgroup>
        <thead>
          <tr class="column-headers">
            <th></th>
            <th>Nom de version</th>
            <th>Date d'audit</th>
            <th>Surface</th>
            <th>Nombre de parcelles</th>
            <th>Statut</th>
            <th></th>
          </tr>
        </thead>
      </table>
    </div>

    <section v-for="{ year, records } in operatorStore.recordsByYear" :key="year" class="year-section fr-mt-4v">
      <div class="year-row" @click="showYears[year] = !showYears[year]">
        <span
            class="fr-icon"
            :class="{ 'fr-icon-arrow-up-s-line': showYears[year], 'fr-icon-arrow-down-s-line': !showYears[year] }"
        />Audit {{ year }}
      </div>
      <div class="fr-table fr-table--bordered" :class="{ 'fr-sr-only': !showYears[year] }">
        <table :aria-label="`Audits ${ year }.`">
          <colgroup>
            <col class="blank-column"/>
            <col class="version-name"/>
            <col class="audit-date"/>
            <col class="surface"/>
            <col class="parcelles"/>
            <col class="statut"/>
            <col class="actions"/>
          </colgroup>
          <thead>
            <tr class="column-headers fr-sr-only">
              <th></th>
              <th>Nom de version</th>
              <th>Date d'audit</th>
              <th>Surface</th>
              <th>Nombre de parcelles</th>
              <th>Statut</th>
              <th></th>
            </tr>
          </thead>
          <tr
              v-for="record in records"
              :key="record?.record_id"
              class="version-row"
              role="link"
              @click="$router.push(`/exploitations/${operatorStore.operator.numeroBio}/${record.record_id}`)"
          >
            <td></td>
            <td><b class="fr-no">{{ record.version_name }}</b></td>
            <td>{{ record.audit_date ? dateFormat(record.audit_date) : 'non audité' }}</td>
            <td>{{ inHa(record.surface) }} ha</td>
            <td>{{ record.parcelles }}</td>
            <td>
              <State :record="record" :show-date="false" />
              <span v-if="record.certification_date_fin" class="fr-hint-text">Date de fin de validité: {{ dateFormat(record.certification_date_fin) }}</span>
            </td>
            <td>
              <ActionDropdown>
                <button type="button" @click.stop.prevent="editVersionModal = record.record_id" class="fr-btn fr-btn--tertiary-no-outline fr-icon-edit-line">
                  Modifier la version
                </button>
                <button
                    type="button"
                    @click.stop.prevent="duplicateVersion(record.record_id)"
                    class="fr-btn fr-btn--tertiary-no-outline fr-icon-duplicate"
                >
                  Dupliquer la version
                </button>
                <button type="button" @click.stop.prevent="deleteRecordModal = record.record_id" class="fr-btn fr-btn--tertiary-no-outline fr-icon-delete-line btn--error">
                  Supprimer la version
                </button>
              </ActionDropdown>
            </td>
          </tr>
        </table>
      </div>
    </section>
    <Teleport to="body">
      <NewVersionModal @close="newVersionModal = false" v-if="newVersionModal" />
      <EditVersionModal
          :model-value="operatorStore.records.find(record => record.record_id === editVersionModal)"
          @update:model-value="Object.assign(operatorStore.records.find(record => record.record_id === $event.record_id), {
          version_name: $event.version_name,
          audit_date: $event.audit_date,
          certification_date_fin: $event.certification_date_fin
        })"
          v-if="editVersionModal"
          @close="editVersionModal = null"
      />
      <DeleteVersionModal v-if="deleteRecordModal" :record="operatorStore.records.find(record => record.record_id === deleteRecordModal)" @close="deleteRecordModal = null" />
    </Teleport>
  </main>
</template>


<script setup>
import { defineAsyncComponent, markRaw, reactive, ref } from 'vue'

import State from "@/components/Certification/State.vue"
import ActionDropdown from "@/components/ActionDropdown.vue"
import EditVersionModal from "@/components/versions/EditVersionModal.vue"
import DeleteVersionModal from "@/components/versions/DeleteVersionModal.vue"
import NewVersionModal from "@/components/versions/NewVersionModal.vue"
import OperatorSetupFlow from '@/components/OperatorSetup/Flow.vue'
import ActionFromScratch from '@/components/OperatorSetup/Actions/FromScratch.vue'
import ActionFromSource from '@/components/OperatorSetup/Actions/FromSource.vue'

import { useOperatorStore, usePermissions } from "@/stores/index.js"
import { sources } from '@/referentiels/imports.js'
import ActionByOperator from "@/components/OperatorSetup/Actions/ByOperator.vue"
import { inHa } from "@/components/Features/index.js"
import { dateFormat } from "@/components/dates.js"
import { createOperatorRecord, getRecord } from "@/cartobio-api.js"
import toast from "@/components/toast.js"

const operatorStore = useOperatorStore()
const permissions = usePermissions()

const operatorSetupActions = [
  ...(permissions.isOc ? [{ id: 'operator', selector: markRaw(ActionByOperator) }] : []),
  {
    id: 'source',
    selector: markRaw(ActionFromSource),
    wizzard: defineAsyncComponent(() => import('@/components/OperatorSetup/Flows/MultiSources.vue')),
    extraProps: {
      sources: [
        sources.GEOFOLIA,
        sources.MESPARCELLES,
        sources.TELEPAC,
        sources.RPG,
        sources.CVI
      ]
    }
  },
  { id: 'manual', selector: markRaw(ActionFromScratch) },
]

const showYears = reactive({
  [new Date().getFullYear()]: true,
  [new Date().getFullYear() - 1]: true
})

async function duplicateVersion(record_id) {
  const recordSummary = operatorStore.records.find(record => record.record_id === record_id)
  const record = await getRecord(record_id)
  const newRecord = await createOperatorRecord(operatorStore.operator.numeroBio, {
    versionName: `Copie de ${record.version_name}`,
    geojson: record.parcelles,
    metadata: {
      provenance: window.location.host,
      source: 'Copie de version existante',
      copy_of: record.record_id
    }
  })
  operatorStore.records?.unshift({
    ...newRecord,
    parcelles: recordSummary.parcelles,
    surface: recordSummary.surface,
  })


  toast.success('La version a été dupliquée')
}

const newVersionModal = ref(false)
const deleteRecordModal = ref(null)
const editVersionModal = ref(null)

</script>

<style scoped>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.fr-table {
  margin: 0;
}

.fr-icon-duplicate::before {
  mask-image: url(@/assets/icon-duplicate.svg);
}

table {
  width: 100%;
  display: table;
  table-layout: fixed;
}

tr.column-headers {
  height: 0;
}

col.blank-column {
  width: 3rem;
}

col.version-name {
  width: 15rem;
}

col.surface {
  width: 10rem;
}

col.audit-date {
  width: 10rem;
}

col.actions {
  width: 5rem;
}

.year-section {
  width: 100%;
  border-radius: 5px;
}

.year-section div.fr-table {
  padding: 0;
  border-radius: 0 0 5px 5px;
  border: 1px solid var(--border-action-low-blue-france);
  border-top: 0;
}

.year-row {
  background-color: var(--background-alt-blue-france);
  color: var(--text-title-blue-france);
  padding: 1rem 1rem 1rem 1rem;
  font-weight: 500;
  border-radius: 5px 5px 0 0;
  overflow: hidden;

  & > span.fr-icon {
    display: inline-block;
    width: 3rem;
  }
}

tr.version-row,
tr.version-row:nth-child(2n) {
  cursor: pointer;
  background-color: white;
}

tr.version-row:hover {
  background-color: var(--background-default-grey-hover);
}
</style>
