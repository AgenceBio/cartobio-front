<route lang="yaml">
meta:
  requiresAuth: true
  seo:
    title: Parcellaires
</route>

<template>
  <div class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">{{ operatorStore.operator.nom }}</a>
        </li>
      </ol>
    </nav>

    <div class="header fr-mb-8v">
      <h1 class="fr-h3 fr-m-0">{{ operatorStore.operator.nom }}</h1>
      <button
        v-if="permissions.canCreateVersion && operatorStore.records && operatorStore.records.length > 0"
        class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line"
        @click="newVersionModal = true"
        :disabled="!isOnline"
      >
        Créer une nouvelle version
      </button>
    </div>

    <OperatorSetupFlow
      v-if="operatorStore.records && !operatorStore.records.length"
      :operator="operatorStore.operator"
      :actions="operatorSetupActions"
      :with-stepper="permissions.isAgri"
      @redirect="$router.push(`/exploitations/${operatorStore.operator.numeroBio}/${$event.record_id}`)"
    >
      <template #introduction>
        <p class="fr-text--lead" v-if="permissions.isOc">Importer un parcellaire d'exploitation agricole.</p>

        <p class="fr-text--lg" v-if="permissions.isAgri">
          Nous vous demandons quelques informations lors d'une <em>première utilisation</em> de CartoBio.
        </p>
        <p class="fr-h6" v-if="permissions.isAgri">Choisir votre mode de création de parcellaire :</p>
      </template>
    </OperatorSetupFlow>

    <Conflict v-if="storage.conflicts.size || storage.dateConflicts.size" />

    <template v-else-if="operatorStore.records && operatorStore.records.length > 0">
      <div class="fr-table table-data fr-table--bordered version-table fr-table--no-caption">
        <table aria-hidden="true" aria-describedby="versions-summary-global">
          <caption>
            Versions du parcellaire de l'exploitation
            {{
              operatorStore.operator.nom
            }}
          </caption>
          <colgroup>
            <col class="blank-column" />
            <col class="version-name" />
            <col class="audit-date" />
            <col class="surface" />
            <col class="parcelles" />
            <col class="statut" />
            <col class="offline" />
            <col class="actions" />
          </colgroup>
          <thead>
            <tr class="column-headers">
              <th></th>
              <th>Nom de version</th>
              <th>Date d'audit</th>
              <th>Surface</th>
              <th>Nombre de parcelles</th>
              <th>Statut</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
        </table>
      </div>

      <p id="versions-summary-global" class="fr-sr-only">Les versions sont regroupées par année d'audit.</p>

      <section v-for="{ year, records } in operatorStore.recordsByYear" :key="year" class="year-section fr-mt-4v">
        <h2
          class="fr-text--md year-row clickable"
          @click="showYears[year] = !showYears[year]"
          @keydown.enter="showYears[year] = !showYears[year]"
          tabindex="0"
          :aria-label="`Audit ${year}`"
          :aria-pressed="showYears[year]"
        >
          <span
            class="fr-icon"
            :class="{ 'fr-icon-arrow-up-s-line': showYears[year], 'fr-icon-arrow-down-s-line': !showYears[year] }"
          />Audit {{ year }}
        </h2>

        <button
          class="fr-btn fr-sr-only"
          v-text="
            showYears[year] ? `Masquer les versions de l'audit ${year}` : `Afficher les versions de l'audit ${year}`
          "
        />

        <div
          class="fr-table table-data fr-table--bordered fr-table--no-caption"
          v-if="showYears[year]"
          aria-live="assertive"
        >
          <table :aria-describedby="`version-summary-${year}`">
            <caption>
              Versions du parcellaire pour l'audit
              {{
                year
              }}
            </caption>
            <colgroup>
              <col class="blank-column" />
              <col class="version-name" />
              <col class="audit-date" />
              <col class="surface" />
              <col class="parcelles" />
              <col class="statut" />
              <col class="offline" />
              <col class="actions" />
            </colgroup>
            <thead>
              <tr class="column-headers fr-sr-only">
                <th></th>
                <th scope="col">Nom de version</th>
                <th scope="col">Date d'audit</th>
                <th scope="col">Surface</th>
                <th scope="col">Nombre de parcelles</th>
                <th scope="col">Statut</th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tr
              v-for="record in records"
              :key="record?.record_id"
              class="version-row fr-enlarge-link"
              :class="{ 'version-row--disabled': !isOnline && !storage.records[record.record_id] }"
              role="link"
              :aria-label="record.version_name"
            >
              <td></td>
              <th scope="row">
                <router-link
                  class="fr-text"
                  :disabled="!isOnline && !storage.records[record.record_id]"
                  :to="`/exploitations/${operatorStore.operator.numeroBio}/${record.record_id}`"
                  :aria-label="record.version_name"
                >
                  {{ record.version_name }}
                </router-link>
              </th>
              <td>{{ record.audit_date ? dateFormat(record.audit_date) : "non audité" }}</td>
              <td>{{ inHa(record.surface) }} ha</td>
              <td>{{ record.parcelles }}</td>
              <td>
                <State :record="record" :show-date="false" />
                <span v-if="record.certification_date_fin" class="fr-hint-text">
                  Du {{ dateFormat(record.certification_date_debut) }} au
                  {{ dateFormat(record.certification_date_fin) }}
                </span>
              </td>
              <td>
                <button
                  v-if="storage.syncQueues[record.record_id]"
                  type="button"
                  class="fr-btn fr-btn--tertiary-no-outline fr-icon-refresh-line"
                  disabled
                >
                  Changements non-synchronisés
                </button>
                <button
                  v-else-if="storage.records[record.record_id]"
                  type="button"
                  class="fr-btn fr-btn--tertiary-no-outline fr-icon-success-fill"
                  @click.stop.prevent="deleteDownloadModal = record.record_id"
                >
                  Supprimer des téléchargements
                </button>
                <button
                  v-else
                  type="button"
                  class="fr-btn fr-btn--tertiary-no-outline fr-icon-download-line"
                  :disabled="!isOnline"
                  @click.stop.prevent="tryDownloadRecord(record.record_id)"
                >
                  Télécharger pour un fonctionnement hors-ligne
                </button>
              </td>
              <td>
                <ActionDropdown with-icons :disabled="!isOnline">
                  <li>
                    <button
                      v-if="permissions.isOc || record.certification_state === CertificationState.OPERATOR_DRAFT"
                      type="button"
                      @click.stop.prevent="editVersion(record.record_id)"
                      class="fr-btn fr-btn--tertiary-no-outline fr-icon-edit-line fr-text--sm"
                    >
                      Modifier les informations
                    </button>
                  </li>
                  <li>
                    <button
                      type="button"
                      @click.stop.prevent="duplicateVersion(record.record_id)"
                      class="fr-btn fr-btn--tertiary-no-outline fr-icon-duplicate fr-text--sm"
                    >
                      Dupliquer la version
                    </button>
                  </li>
                  <li>
                    <button
                      v-if="permissions.isOc || record.certification_state === CertificationState.OPERATOR_DRAFT"
                      type="button"
                      @click.stop.prevent="deleteRecordModal = record.record_id"
                      class="fr-btn fr-btn--tertiary-no-outline fr-icon-delete-line btn--error fr-text--sm"
                    >
                      Supprimer la version
                    </button>
                  </li>
                </ActionDropdown>
              </td>
            </tr>
          </table>

          <p :id="`version-summary-${year}`" class="fr-sr-only">
            La première colonne contient le nom de version ; la deuxième colonne, la date d'audit ; la troisième
            colonne, la surface en hectares ; la quatrième colonne, le nombre de parcelles ; la cinquième colonne, le
            statut du parcellaire ; la sixième et dernière colonne, des boutons d'action.
          </p>
        </div>
      </section>
    </template>
    <Teleport to="body">
      <NewVersionModal @close="newVersionModal = false" v-if="newVersionModal" />
      <EditVersionModal v-if="editVersionModal" @close="editVersionModal = null" />
      <DeleteVersionModal
        v-if="deleteRecordModal"
        :record="operatorStore.records.find((record) => record.record_id === deleteRecordModal)"
        @close="deleteRecordModal = null"
      />
      <DeleteDownloadModal
        v-if="deleteDownloadModal"
        :record-id="deleteDownloadModal"
        @close="deleteDownloadModal = null"
      />
      <FullStorageModal v-if="fullStorageModal" @close="fullStorageModal = false" />
    </Teleport>
  </div>
</template>

<script setup>
import { defineAsyncComponent, markRaw, reactive, ref } from "vue";
import { useHead } from "@unhead/vue";

import State from "@/components/records/State.vue";
import ActionDropdown from "@/components/widgets/ActionDropdown.vue";
import EditVersionModal from "@/components/forms/EditVersionForm.vue";
import DeleteVersionModal from "@/components/versions/DeleteVersionModal.vue";
import DeleteDownloadModal from "@/components/versions/DeleteDownloadModal.vue";
import NewVersionModal from "@/components/versions/NewVersionModal.vue";
import FullStorageModal from "@/components/versions/FullStorageModal.vue";
import OperatorSetupFlow from "@/components/setup/Flow/index.vue";
import ActionFromScratch from "@/components/setup/actions/FromScratch.vue";
import ActionFromSource from "@/components/setup/actions/FromSource.vue";
import ActionByOperator from "@/components/setup/actions/ByOperator.vue";

import { useOperatorStore } from "@/stores/operator.js";
import { usePermissions } from "@/stores/permissions.js";
import { sources } from "@/referentiels/imports.js";
import { dateFormat } from "@/utils/dates.js";
import toast from "@/utils/toast.js";
import { useRecordStore } from "@/stores/record.js";
import { useOnline } from "@vueuse/core";
import { useCartoBioStorage } from "@/stores/storage.js";
import Conflict from "@/components/versions/Conflict.vue";
import { inHa } from "@/utils/features.js";
import { CertificationState } from "@agencebio/cartobio-types";

const operatorStore = useOperatorStore();
const recordStore = useRecordStore();
const permissions = usePermissions();
const storage = useCartoBioStorage();
const isOnline = useOnline();

const newVersionModal = ref(false);
const deleteRecordModal = ref(null);
const deleteDownloadModal = ref(null);
const editVersionModal = ref(null);
const fullStorageModal = ref(false);

const operatorSetupActions = [
  ...(permissions.isOc ? [{ id: "operator", selector: markRaw(ActionByOperator) }] : []),
  {
    id: "source",
    selector: markRaw(ActionFromSource),
    wizzard: defineAsyncComponent(() => import("@/components/setup/MultiSources/index.vue")),
    extraProps: {
      sources: [
        sources.GEOFOLIA,
        sources.MESPARCELLES,
        sources.TELEPAC,
        sources.CVI,
        sources.ANYGEO,
        ...(permissions.isOc ? [sources.RPG] : []),
      ],
    },
  },
  { id: "manual", selector: markRaw(ActionFromScratch) },
];

const showYears = reactive({
  [new Date().getFullYear()]: true,
  [new Date().getFullYear() - 1]: true,
});

useHead({
  title: `Versions du parcellaire - ${operatorStore.operator.nom}`,
});

async function editVersion(recordId) {
  await recordStore.ready(recordId);
  editVersionModal.value = recordId;
}

async function duplicateVersion(recordId) {
  await recordStore.duplicate(recordId);

  toast.success("La version a été dupliquée");
}

async function tryDownloadRecord(recordId) {
  if (!(await storage.addRecord(recordId))) {
    fullStorageModal.value = true;
  } else {
    toast.success("Le parcellaire a bien été téléchargé.");
  }
}
</script>

<style scoped>
.header {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  justify-content: space-between;

  @media (width >= 36em) {
    align-items: center;
    flex-direction: row;
  }
}

.fr-table {
  margin: 0;
}

.fr-icon-duplicate::before {
  mask-image: url(@/assets/icon-duplicate.svg);
}

table {
  width: 100%;
  table-layout: fixed;

  tr:last-child {
    border-radius: 0 0 5px 5px;
  }
}

tr.column-headers {
  height: 0;
}

col.blank-column {
  width: 3rem;
}

col.version-name {
  width: 15rem;
}

col.audit-date {
  width: 10rem;
}

col.surface {
  width: 10rem;
}

col.statut {
  width: 15rem;
}

col.offline {
  width: 5rem;
}

col.actions {
  width: 5rem;
}

.year-section {
  width: 100%;
  border-radius: 5px;
}

.year-section div.fr-table {
  padding: 0;
  border-radius: 0 0 5px 5px;
  border: 1px solid var(--border-action-low-blue-france);
  border-top: 0;
}

.year-row {
  background-color: var(--background-alt-blue-france);
  color: var(--text-title-blue-france);
  padding: 1rem 1rem 1rem 1rem;
  margin: 0;
  font-weight: 500;
  border-radius: 5px 5px 0 0;
  overflow: hidden;

  &:hover,
  &:focus {
    background-color: var(--background-alt-blue-france-hover);
  }

  & > span.fr-icon {
    display: inline-block;
    width: 3rem;
  }
}

tr.fr-enlarge-link {
  :deep(button) {
    position: relative;
    z-index: 10;
  }
}

tr.version-row,
tr.version-row:nth-child(2n) {
  cursor: pointer;
  background-color: transparent;
}

tr.version-row--disabled,
tr.version-row--disabled:nth-child(2n) {
  background-color: var(--background-default-grey-hover);
  color: var(--text-disabled-grey);
  cursor: default;

  :deep(.fr-btn) {
    color: var(--text-disabled-grey) !important;
  }
}

tr.version-row:hover {
  background-color: var(--background-default-grey-hover);

  button,
  :deep(button) {
    --hover-tint: var(--background-default-grey-active);
  }
}
</style>
