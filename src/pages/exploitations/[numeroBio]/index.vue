<route lang="yaml">
meta:
  requiresAuth: true
  seo:
    title: Parcellaire
</route>

<template>
  <section v-if="!recordStore.isSetup" class="fr-container fr-py-2w">
    <p v-if="permissions.isOc">
      <router-link to="/certification/exploitations" class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-left-line">
        Retour à mes clients
      </router-link>
    </p>

    <OperatorSummary v-if="permissions.isOc" :operator="record.operator" :record="recordStore.record" />
    <OperatorSetupFlow :operator="record.operator" :actions="operatorSetupActions" :with-stepper="permissions.isAgri">
      <template #introduction>
        <p class="fr-text--lead" v-if="permissions.isOc">Importer un parcellaire d'exploitation agricole.</p>

        <p class="fr-text--lg" v-if="permissions.isAgri">
          Nous vous demandons quelques informations lors
          d'une <em>première utilisation</em> de CartoBio.
        </p>
        <p class="fr-h6" v-if="permissions.isAgri">
          Choisir votre mode de création de parcellaire :
        </p>
      </template>
    </OperatorSetupFlow>
  </section>

  <section class="fr-container fr-py-2w" v-else>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <p v-if="permissions.isOc">
          <router-link to="/certification/exploitations" class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-left-line">
            Retour à mes clients
          </router-link>
        </p>

        <OperatorSummary :operator="record.operator" :record="record" />

        <CertificationSummary v-if="permissions.isOc" :operator="record.operator" :record="recordStore.record" :features="featureStore.collection" :validation-rules="validationRules" />
        <div class="fr-alert fr-alert--warning fr-my-5w" v-if="permissions.isAgri && hasFailures">
          <ValidationErrors :validation-result="validationResult" />
        </div>

        <FeaturesTable :operator="record.operator" :edit-form="EditForm" :validation-rules="validationRules" :mass-actions="massActions" />
      </div>

      <div class="fr-col-6 fr-col--map">
        <div class="sticky-map" :class="{ 'sticky-map--full-size': isMapFullSize }">
          <div :class="{ 'full-size-map fr-card fr-card--shadow fr-p-2w': isMapFullSize }">
            <MapContainer class="map" :class="{ 'map--full-size': isMapFullSize }" :mode="isMapFullSize ? 'fullsize' : 'compact'" :bounds="mapBounds" :show-attribution="true" ref="mapRef">
              <LayerSelector v-model:fond="fond" v-model:classification="showClassification" v-model:cadastre="showCadastre" v-model:ilots="showIlots" />
              <GeojsonLayer v-if="fond === 'plan'" :style="baseStyle" name="base" :before="showCadastre ? 'cadastre' : showClassification ? 'surroundings' : 'parcellaire-operateur'" />
              <GeojsonLayer v-if="fond === 'satellite'" :style="satelliteStyle" name="satellite" :before="showCadastre ? 'cadastre' : showClassification ? 'surroundings' : 'parcellaire-operateur'" />
              <GeojsonLayer v-if="showCadastre" :style="cadastreStyle" name="cadastre" before="parcellaire-operateur" />
              <GeojsonLayer v-if="showClassification" :style="surroundingsStyle" name="surroundings" before="parcellaire-operateur" />

              <FeaturesLayer :show-numeros-ilots="showIlots" interactive />
              <CustomControls @center="focusOnOriginalBbox" v-model:large="isMapFullSize" />
            </MapContainer>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, defineAsyncComponent, markRaw, ref, shallowRef } from 'vue'
import { storeToRefs } from 'pinia'
import { bounds } from '@/components/Features/index.js'

import FeaturesTable from '@/components/Features/Table.vue'
import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import baseStyle from '@/map-styles/base.json'
import SingleItemOperatorForm from '@/components/Features/SingleItemOperatorForm.vue'
import SingleItemCertificationBodyForm from "@/components/Features/SingleItemCertificationBodyForm.vue"
import OperatorSummary from '@/components/Operator/Summary.vue'
import CultureTypeModal from '@/components/Operator/CultureTypeModal.vue'

import OperatorSetupFlow from '@/components/OperatorSetup/Flow.vue'
import ActionFromScratch from '@/components/OperatorSetup/Actions/FromScratch.vue'
import ActionFromSource from '@/components/OperatorSetup/Actions/FromSource.vue'

import { useFeaturesStore, usePermissions, useRecordStore } from "@/stores/index.js"
import { applyValidationRules, AUDITOR_RULES, OPERATOR_RULES } from '@/referentiels/ab.js'
import { sources } from '@/referentiels/imports.js'
import surroundingsStyle from "@/map-styles/surroundings.json";
import cadastreStyle from "@/map-styles/cadastre.json";
import ValidationErrors from "@/components/Features/ValidationErrors.vue"
import FeaturesLayer from "@/components/Map/FeaturesLayer.vue"
import LayerSelector from "@/components/Map/LayerSelector.vue"
import CustomControls from "@/components/Map/CustomControls.vue"
import satelliteStyle from "@/map-styles/satellite.json"
import CertificationSummary from "@/components/Certification/Summary.vue"
import EngagementDateModal from "@/components/Certification/EngagementDateModal.vue"
import EngagementLevelModal from "@/components/Certification/EngagementLevelModal.vue"
import ActionByOperator from "@/components/OperatorSetup/Actions/ByOperator.vue"

const recordStore = useRecordStore()
const featureStore = useFeaturesStore()
const permissions = usePermissions()
const { record } = storeToRefs(recordStore)

const mapRef = shallowRef(null)
const fond = ref('plan')
const showClassification = ref(false)
const showCadastre = ref(false)
const showIlots = ref(true)
const isMapFullSize = ref(false)

const validationRules = computed(() => ({ rules: permissions.isOc ? AUDITOR_RULES : OPERATOR_RULES }))
const validationResult = computed(() => applyValidationRules(OPERATOR_RULES, ...featureStore.collection.features))
const hasFailures = computed(() => Boolean(validationResult.value.failures))

const EditForm = computed(() => permissions.isOc ? markRaw(SingleItemCertificationBodyForm) : markRaw(SingleItemOperatorForm))
const massActions = computed(() => permissions.isOc ? [
  { label: 'Modifier les cultures', component: markRaw(CultureTypeModal) },
  { label: 'Ajouter une date d\'engagement', component: markRaw(EngagementDateModal) },
  { label: 'Modifier le statut des parcelles', component: markRaw(EngagementLevelModal) },
]: permissions.canChangeCulture ? [
  { label: 'Modifier les cultures', component: markRaw(CultureTypeModal) },
] : [])

const operatorSetupActions = [
  ...(permissions.isOc ? [{ id: 'operator', selector: markRaw(ActionByOperator) }] : []),
  {
    id: 'source',
    selector: markRaw(ActionFromSource),
    wizzard: defineAsyncComponent(() => import('@/components/OperatorSetup/Flows/MultiSources.vue')),
    extraProps: {
      sources: [sources.TELEPAC]
    }
  },
  { id: 'manual', selector: markRaw(ActionFromScratch) },
]

const mapBounds = computed(() => bounds(featureStore.collection))

function focusOnOriginalBbox () {
  zoomInto(featureStore.collection, { maxZoom: 12 })
}

function zoomInto (featureOrFeatureCollection, { maxZoom }) {
  const newBounds = bounds(featureOrFeatureCollection)
  const { center, zoom, bearing } = mapRef.value.map.cameraForBounds(newBounds, { padding: 50, maxZoom }) ?? {}
  if (center && zoom) {
    mapRef.value.map.flyTo({ center, zoom, bearing })
  }
}
</script>

<style scoped>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: relative;
}

.map--full-size {
  height: calc(90vh - 5rem);
}

.fr-col--map {
  position: relative;
}

.sticky-map {
  width: 100%;
  position: sticky;
  top: 2rem;
  z-index: var(--z-index-map);
}

.sticky-map--full-size {
  height: 90vh;
  z-index: var(--z-index-map-large)
}

.full-size-map {
  width: 180%;
  position: absolute;
  right: 0;
  background: #fff;
  height: 90vh;
}
</style>
