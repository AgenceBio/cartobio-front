<route lang="yaml">
meta:
  requiresAuth: true
  skipLinks:
    Parcellaire: "#parcellaire-table"
    Carte du parcellaire: "#parcellaire-map"
  seo:
    title: Parcellaire
</route>

<template>
  <div class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li>
          <router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}`">{{
            operator.nom
          }}</router-link>
        </li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">{{ record.version_name }}</a>
        </li>
      </ol>
    </nav>

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-lg-6" aria-live="assertive">
        <RecordHeader />

        <fieldset
          role="list"
          class="fr-segmented fr-segmented--sm fr-hidden-lg fr-hidden-xl"
          aria-labelledby="viewmode-switcher-heading"
        >
          <legend class="fr-segmented__legend" id="viewmode-switcher-heading" aria-label="Choix de la vue affichée">
            Vue
          </legend>
          <div class="fr-segmented__elements">
            <div class="fr-segmented__element" role="listitem">
              <input type="radio" name="vue" id="vue-parcellaire" value="parcellaire" v-model="vue" />
              <label class="fr-label fr-icon-table-line" for="vue-parcellaire">Parcellaire</label>
            </div>
            <div class="fr-segmented__element" role="listitem">
              <input type="radio" name="vue" id="vue-carte" value="carte" v-model="vue" />
              <label class="fr-label fr-icon-map-pin-2-line" for="vue-carte">Carte</label>
            </div>
          </div>
        </fieldset>

        <div
          class="fr-unhidden-lg fr-mt-3w"
          :class="{ 'fr-hidden': vue !== 'parcellaire' }"
          :aria-hidden="vue !== 'parcellaire'"
        >
          <CertificationSection />

          <div
            v-if="record.record_id !== operatorStore.records?.[0]?.record_id"
            class="fr-alert fr-alert--warning fr-alert--sm fr-my-2w"
          >
            <p>Cette version du parcellaire n'est pas la plus récente.</p>
          </div>
          <FeaturesTable :edit-form="EditForm" :mass-actions="massActions" />
        </div>
      </div>

      <div
        class="fr-col-12 fr-col-lg-6 fr-unhidden-lg fr-col--map"
        :class="{ 'fr-hidden': vue !== 'carte' }"
        :aria-hidden="vue !== 'carte'"
      >
        <div class="sticky-map" :class="{ 'sticky-map--full-size': isMapFullSize }">
          <div :class="{ 'full-size-map fr-card fr-card--shadow fr-p-2w': isMapFullSize }">
            <MapContainer
              class="map"
              :class="{ 'map--full-size': isMapFullSize }"
              :mode="isMapFullSize ? 'fullsize' : 'compact'"
              :bounds="recordStore.bounds"
              :show-attribution="true"
              ref="mapRef"
              map-id="parcellaire-map"
            >
              <h2 class="fr-sr-only" id="parcellaire">Carte interactive</h2>

              <LayerSelector
                v-model:fond="mapPrefs.background"
                v-model:classification="mapPrefs.rpg"
                v-model:cadastre="mapPrefs.cadastre"
              />
              <GeojsonLayer
                v-if="mapPrefs.background === 'plan'"
                :style="baseStyle"
                name="base"
                :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'"
              />
              <GeojsonLayer
                v-if="mapPrefs.background === 'satellite'"
                :style="satelliteStyle"
                name="satellite"
                :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'"
              />
              <GeojsonLayer
                v-if="mapPrefs.cadastre"
                :style="cadastreStyle"
                name="cadastre"
                before="parcellaire-operateur"
              />
              <GeojsonLayer
                v-if="mapPrefs.rpg"
                :style="surroundingsStyle"
                name="surroundings"
                before="parcellaire-operateur"
              />

              <FeaturesLayer interactive />
              <CustomControls @center="focusOnOriginalBbox" v-model:large="isMapFullSize" />
            </MapContainer>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, markRaw, ref, shallowRef } from "vue";
import { useHead } from "@unhead/vue";
import { storeToRefs } from "pinia";

import RecordHeader from "@/components/records/Header.vue";
import CertificationSection from "@/components/records/CertificationSection.vue";

import FeaturesTable from "@/components/records/Table/index.vue";
import MapContainer from "@/components/map/MapContainer.vue";
import GeojsonLayer from "@/components/map/GeojsonLayer.vue";
import baseStyle from "@/map-styles/base.json";
import SingleItemOperatorForm from "@/components/forms/SingleItemOperatorForm.vue";
import SingleItemCertificationBodyForm from "@/components/forms/SingleItemCertificationBodyForm.vue";
import CultureTypeModal from "@/components/forms/CultureTypeForm.vue";

import { useFeaturesStore } from "@/stores/features.js";
import { useOperatorStore } from "@/stores/operator.js";
import { usePermissions } from "@/stores/permissions.js";
import { usePreferences } from "@/stores/preferences.js";
import { useRecordStore } from "@/stores/record.js";
import surroundingsStyle from "@/map-styles/surroundings.json";
import cadastreStyle from "@/map-styles/cadastre.json";
import FeaturesLayer from "@/components/map/FeaturesLayer.vue";
import LayerSelector from "@/components/map/LayerSelector.vue";
import CustomControls from "@/components/map/CustomControls.vue";
import satelliteStyle from "@/map-styles/satellite.json";
import EngagementDateModal from "@/components/forms/EngagementDateForm.vue";
import EngagementLevelModal from "@/components/forms/EngagementLevelForm.vue";
import { bounds } from "@/utils/features.js";

const featureStore = useFeaturesStore();
const operatorStore = useOperatorStore();
const permissions = usePermissions();
const preferences = usePreferences();
const recordStore = useRecordStore();

const { record } = recordStore;
const { operator } = operatorStore;

const vue = ref("parcellaire");

const mapRef = shallowRef(null);
const { map: mapPrefs } = storeToRefs(preferences);
const isMapFullSize = ref(false);

const EditForm = computed(() =>
  permissions.isOc ? markRaw(SingleItemCertificationBodyForm) : markRaw(SingleItemOperatorForm),
);
const massActions = computed(() =>
  permissions.isOc
    ? [
        { label: "Modifier les cultures", component: markRaw(CultureTypeModal) },
        { label: "Ajouter une date de début de conversion", component: markRaw(EngagementDateModal) },
        { label: "Modifier le statut des parcelles", component: markRaw(EngagementLevelModal) },
      ]
    : permissions.canChangeCulture
      ? [{ label: "Modifier les cultures", component: markRaw(CultureTypeModal) }]
      : [],
);

useHead({
  title: `${record.version_name} - ${operator.nom}`,
});

function focusOnOriginalBbox() {
  zoomInto(featureStore.collection, { maxZoom: 12 });
}

function zoomInto(featureOrFeatureCollection, { maxZoom }) {
  const newBounds = bounds(featureOrFeatureCollection);
  const { center, zoom, bearing } = mapRef.value.map.cameraForBounds(newBounds, { padding: 50, maxZoom }) ?? {};
  if (center && zoom) {
    mapRef.value.map.flyTo({ center, zoom, bearing });
  }
}
</script>

<style scoped>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: relative;
}

.map--full-size {
  height: calc(90vh - 5rem);
}

.fr-col--map {
  position: relative;
}

.sticky-map {
  width: 100%;
  position: sticky;
  top: 2rem;
  z-index: var(--z-index-map);
}

.sticky-map--full-size {
  height: 90vh;
  z-index: var(--z-index-map-large);
}

.full-size-map {
  width: 180%;
  position: absolute;
  right: 0;
  background: #fff;
  height: 90vh;
}
</style>
