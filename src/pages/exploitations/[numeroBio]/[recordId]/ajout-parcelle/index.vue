<route lang="yaml">
  meta:
    requiredPermissions: ['canAddParcelle']
    seo:
      title: Ajouter une parcelle
</route>

<template>
  <section class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li><router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}`">{{ operator.nom }}</router-link></li>
        <li><router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}/${ record.record_id }`">{{ record.version_name }}</router-link></li>
        <li><a class="fr-breadcrumb__link" aria-current="page">Ajout de parcelle</a></li>
      </ol>
    </nav>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">

        <RecordHeader disable-actions />

        <FeatureAddFlow :back-link="backLink" @update="pendingChangesCollection = $event" />
      </div>

      <div class="fr-col-6">
        <MapContainer v-if="recordStore.isSetup" :options="{ interactive: true }" class="map" :bounds="mapBounds">
          <LayerSelector v-model:fond="mapPrefs.background" v-model:classification="mapPrefs.rpg" v-model:cadastre="mapPrefs.cadastre" />
          <GeojsonLayer v-if="mapPrefs.background === 'plan'" :style="baseStyle" name="base" :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'" />
          <GeojsonLayer v-if="mapPrefs.background === 'satellite'" :style="satelliteStyle" name="satellite" :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'" />
          <GeojsonLayer v-if="mapPrefs.cadastre" :style="cadastreStyle" name="cadastre" before="parcellaire-operateur" />
          <GeojsonLayer v-if="mapPrefs.rpg" :style="surroundingsStyle" name="surroundings" before="parcellaire-operateur" />
          <GeojsonLayer v-if="pendingChangesCollection" :data="pendingChangesCollection" name="pending-changes" :fill="{ 'fill-color': '#FDE2B5', 'fill-outline-color': '#000091', 'fill-opacity': 0.8 }" />

          <FeaturesLayer />
        </MapContainer>
        <SetupOverlay v-else>
          Parcellaire inconnu
        </SetupOverlay>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, shallowRef } from 'vue'
import { useHead } from '@unhead/vue'
import { storeToRefs } from 'pinia'

import MapContainer from '@/components/map/MapContainer.vue'
import GeojsonLayer from '@/components/map/GeojsonLayer.vue'
import SetupOverlay from '@/components/records/EmptyOverlay.vue'
import RecordHeader from '@/components/records/Header.vue'
import FeatureAddFlow from '@/components/records/AddFeatureFlow.vue'

import baseStyle from '@/map-styles/base.json'
import cadastreStyle from '@/map-styles/cadastre.json'

import { useOperatorStore } from "@/stores/operator.js"
import { usePermissions } from "@/stores/permissions.js"
import { usePreferences } from "@/stores/preferences.js"
import { useRecordStore } from "@/stores/record.js"
import satelliteStyle from "@/map-styles/satellite.json"
import surroundingsStyle from "@/map-styles/surroundings.json"
import LayerSelector from "@/components/map/LayerSelector.vue"
import FeaturesLayer from "@/components/map/FeaturesLayer.vue"
import { bounds } from "@/utils/features.js"

defineProps({
  numeroBio: {
    type: String,
    required: true
  }
})

const operatorStore = useOperatorStore()
const recordStore = useRecordStore()
const preferences = usePreferences()
const permissions = usePermissions()
const { operator } = operatorStore
const { record } = recordStore

const { map: mapPrefs } = storeToRefs(preferences)
const backLink = `/exploitations/${operator.numeroBio}/${record.record_id}`

const pendingChangesCollection = shallowRef(null)
const mapBounds = computed(() => {
  if (pendingChangesCollection.value) {
    return bounds(pendingChangesCollection.value)
  }

  if (recordStore.isSetup) {
    return recordStore.bounds
  }

  return []
})

useHead({
  title: `Ajouter une parcelle - ${record.version_name} - ${operator.nom}`
})
</script>

<style scoped>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  top: 0;
  width: 100%;
}
</style>
