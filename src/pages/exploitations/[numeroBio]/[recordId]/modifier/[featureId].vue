<route lang="yaml">
meta:
  requiredPermissions: ["canChangeGeometry"]
  seo:
    title: Modifier le tracé de la parcelle
</route>

<template>
  <section class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li>
          <router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}`">{{
            operator.nom
          }}</router-link>
        </li>
        <li>
          <router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}/${record.record_id}`">{{
            record.version_name
          }}</router-link>
        </li>
        <li><a class="fr-breadcrumb__link" aria-current="page">Modifier une parcelle</a></li>
      </ol>
    </nav>

    <RecordHeader disable-actions />
    <h3 class="fr-h5 fr-my-3v">
      Modifier le contour de «&nbsp;{{ modifiedFeature && featureName(modifiedFeature) }}&nbsp;»
    </h3>

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-9">
        <div v-if="loadingError" class="fr-alert fr-alert--error fr-my-3v">
          <p>{{ loadingError }}</p>
        </div>
        <MapContainer
          v-if="recordStore.isSetup"
          :options="{ interactive: true }"
          class="map"
          :bounds="mapBounds"
          ref="map"
        >
          <LayerSelector
            v-model:fond="mapPrefs.background"
            v-model:classification="mapPrefs.rpg"
            v-model:cadastre="mapPrefs.cadastre"
            v-model:ilots="showIlots"
          />
          <GeojsonLayer
            v-if="mapPrefs.background === 'plan'"
            :style="baseStyle"
            name="base"
            :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'"
          />
          <GeojsonLayer
            v-if="mapPrefs.background === 'satellite'"
            :style="satelliteStyle"
            name="satellite"
            :before="mapPrefs.cadastre ? 'cadastre' : mapPrefs.rpg ? 'surroundings' : 'parcellaire-operateur'"
          />
          <GeojsonLayer
            v-if="mapPrefs.cadastre"
            :style="cadastreStyle"
            name="cadastre"
            before="parcellaire-operateur"
          />
          <GeojsonLayer
            v-if="mapPrefs.rpg"
            :style="surroundingsStyle"
            name="surroundings"
            before="parcellaire-operateur"
          />

          <FeaturesLayer :data="otherCollection" :show-numeros-ilots="showIlots" />
        </MapContainer>
      </div>
      <div class="fr-col-3">
        <div class="controls">
          <p><b>Mode d'emploi</b></p>
          <ol>
            <li><b>Commencer l'édition:</b> Cliquez sur votre parcelle.</li>
            <li><b>Modifier&nbsp;:</b> Déplacer les gros points pour bouger les sommets.</li>
            <li><b>Ajouter un sommet&nbsp;: </b>Cliquez sur les petits points pour ajouter des sommets.</li>
            <li><b>Enregistrer&nbsp;:</b> Cliquez sur «&nbsp;Enregister le tracé&nbsp;».</li>
          </ol>
          <button
            class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-go-back-fill fr-mb-4w"
            @click="reset"
            :disabled="loadingError || feature === null"
          >
            Réinitialiser le tracé
          </button>
          <div v-if="!loadingError && error" class="fr-alert fr-alert--error">
            <p>{{ error }}</p>
          </div>
          <button
            class="fr-btn fr-btn--primary fr-btn--icon-left fr-icon-save-fill"
            :disabled="error !== '' || loadingError !== ''"
            @click="showConfirmModal = true"
          >
            Enregistrer le tracé
          </button>
        </div>
      </div>
    </div>
  </section>

  <Teleport to="body">
    <Modal v-if="showConfirmModal" @close="showConfirmModal = false" icon="fr-icon-geometry">
      <template #title>Modifier le contour</template>
      <template #default>
        <p>
          Vous êtes sur le point de modifier le contour de la parcelle « {{ featureName(modifiedFeature) }} » votre
          tracé
        </p>
        <p>Sa superficie est désormais de {{ inHa(legalProjectionSurface(modifiedFeature)) }} ha.</p>
      </template>
      <template #footer>
        <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--left fr-btns-group--icon-left">
          <li><button class="fr-btn fr-btn--primary" @click="saveFeature">Enregistrer</button></li>
          <li><button class="fr-btn fr-btn--secondary" @click="showConfirmModal = false">Annuler</button></li>
        </ul>
      </template>
    </Modal>
  </Teleport>
</template>

<script setup>
import { computed, onMounted, ref, watch } from "vue";
import { useHead } from "@unhead/vue";
import { storeToRefs } from "pinia";
import { useRouter } from "vue-router";
import { feature, featureCollection } from "@turf/helpers";

import baseStyle from "@/map-styles/base.json";
import MapContainer from "@/components/map/MapContainer.vue";
import GeojsonLayer from "@/components/map/GeojsonLayer.vue";
import { useRecordStore } from "@/stores/record.js";
import { useOperatorStore } from "@/stores/operator.js";
import { useFeaturesStore } from "@/stores/features.js";
import { usePreferences } from "@/stores/preferences.js";
import { usePermissions } from "@/stores/permissions.js";
import { TerraDraw, TerraDrawMapLibreGLAdapter, TerraDrawPolygonMode, TerraDrawSelectMode } from "terra-draw";
import intersect from "@turf/intersect";
import { statsPush } from "@/stats.js";
import Modal from "@/components/widgets/Modal.vue";
import toast from "@/utils/toast.js";
import satelliteStyle from "@/map-styles/satellite.json";
import cadastreStyle from "@/map-styles/cadastre.json";
import surroundingsStyle from "@/map-styles/surroundings.json";
import LayerSelector from "@/components/map/LayerSelector.vue";
import FeaturesLayer from "@/components/map/FeaturesLayer.vue";
import RecordHeader from "@/components/records/Header.vue";
import { bounds, featureName, inHa, legalProjectionSurface } from "@/utils/features.js";

const props = defineProps({
  numeroBio: {
    type: String,
    required: true,
  },
  featureId: {
    type: String,
    required: true,
  },
});

const permissions = usePermissions();
const operatorStore = useOperatorStore();
const recordStore = useRecordStore();
const featuresStore = useFeaturesStore();
const preferences = usePreferences();
const router = useRouter();
const { operator } = operatorStore;
const { record } = recordStore;

const otherCollection = computed(() =>
  loadingError.value
    ? featuresStore.collection
    : featureCollection(featuresStore.collection.features.filter((f) => f.id !== String(props.featureId))),
);
const modifiedFeature = ref(null);

const mapBounds = computed(() => bounds(featuresStore.getFeatureById(String(props.featureId))));

const map = ref(null); // MapContainer instance
const { map: mapPrefs } = storeToRefs(preferences);
const showIlots = ref(false);

let draw; // TerraDraw instance
const loadingError = ref("");
const error = ref("");
const showConfirmModal = ref(false);

const COORDINATE_PRECISION = 16;

useHead({
  title: `Modifier le dessin d'une parcelle - ${record.version_name} - ${operator.nom}`,
});

onMounted(() => {
  draw = new TerraDraw({
    adapter: new TerraDrawMapLibreGLAdapter({ map: map.value.map, coordinatePrecision: COORDINATE_PRECISION }),
    modes: [
      new TerraDrawPolygonMode({
        coordinatePrecision: COORDINATE_PRECISION,
        allowSelfIntersections: false,
        styles: {
          fillColor: "#000091",
          fillOpacity: 0.1,
          outlineColor: "#000091",
          outlineWidth: 2,
          closingPointColor: "#000091",
        },
      }),
      new TerraDrawSelectMode({
        coordinatePrecision: COORDINATE_PRECISION,
        styles: {
          selectedPolygonColor: "#000091",
          selectedPolygonFillOpacity: 0.1,
          selectedPolygonOutlineColor: "#000091",
          selectedPolygonOutlineWidth: 2,
          selectionPointColor: "#000091",
          midPointColor: "#000091",
        },
        flags: {
          polygon: {
            feature: {
              draggable: true,
              rotateable: true,
              scaleable: true,
              selfIntersectable: false,
              coordinates: {
                midpoints: true,
                draggable: true,
                deletable: true,
              },
            },
          },
        },
      }),
    ],
  });
  draw.start();
  loadFeature();
  draw.on("finish", () => {
    modifiedFeature.value.geometry = draw.getSnapshot()[0].geometry;
  });
});

function loadFeature() {
  draw.setMode("polygon");
  const terraDrawFeature = feature(featuresStore.getFeatureById(String(props.featureId)).geometry);

  // Convert multipolygon to polygon
  if (terraDrawFeature.geometry.type === "MultiPolygon") {
    terraDrawFeature.geometry.coordinates = terraDrawFeature.geometry.coordinates[0];
    terraDrawFeature.geometry.type = "Polygon";
  }
  // Round coordinates to COORDINATE_PRECISIONS - 1 decimals
  terraDrawFeature.geometry.coordinates = terraDrawFeature.geometry.coordinates.map((ring) =>
    ring.map((point) => point.map((c) => Number(c.toFixed(COORDINATE_PRECISION - 1)))),
  );
  terraDrawFeature.properties.mode = "polygon";
  try {
    draw.addFeatures([terraDrawFeature]);
  } catch (e) {
    if (e.message.startsWith("Feature is not")) {
      loadingError.value =
        "La modification de contour n’est pas encore disponible pour les parcelles évidées. Veuillez nous en excuser.";
    } else {
      throw e;
    }
  }

  // Clone feature to avoid modifying the featureStore
  modifiedFeature.value = JSON.parse(JSON.stringify(featuresStore.getFeatureById(String(props.featureId))));
  draw.setMode("select");
}

function reset() {
  draw.clear();
  loadFeature();
}

watch(
  modifiedFeature,
  () => {
    if (otherCollection.value.features.some((f) => intersect(f, modifiedFeature.value))) {
      error.value =
        "Le contour que vous avez tracé recoupe l’une de vos parcelles existantes. Vous ne pouvez pas enregistrer ce contour.";
    } else {
      error.value = "";
    }
  },
  { deep: true },
);

async function saveFeature() {
  await featuresStore.updateSingleFeature(modifiedFeature.value);

  statsPush(["trackEvent", "Parcelles", "Modification (tracé)"]);
  await router.push(`/exploitations/${props.numeroBio}/${record.record_id}`);

  toast.success(`Parcelle « ${featureName(modifiedFeature.value)} » modifiée.`, "Voir la parcelle", () => {
    featuresStore.select(modifiedFeature.value.id);
  });
}
</script>

<style scoped>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  top: 0;
  width: 100%;
}

.controls {
  position: relative;
  height: 100%;
}

.controls > *:nth-last-child(1) {
  position: absolute;
  bottom: 0;
  left: 0;
}

.fr-icon-geometry::before {
  mask-image: url(@/assets/icon-geometry.svg);
}
</style>
