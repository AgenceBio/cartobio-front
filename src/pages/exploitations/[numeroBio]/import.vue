<route lang="yaml">
meta:
  requiredPermissions: ["canCreateVersion"]
  seo:
    title: Importer un parcellaire informatisé
</route>

<script setup>
import { defineAsyncComponent, markRaw } from "vue";
import { useHead } from "@unhead/vue";
import OperatorSetupFlow from "@/components/setup/Flow/index.vue";

import { useOperatorStore } from "@/stores/operator.js";
import { useRouter } from "vue-router";
import { usePermissions } from "@/stores/permissions.js";
import ActionFromSource from "@/components/setup/actions/FromSource.vue";
import { sources } from "@/referentiels/imports.js";
import { storeToRefs } from "pinia";
import toast from "@/utils/toast";
import { hhmm } from "@/utils/dates";

const operatorStore = useOperatorStore();
const permissions = usePermissions();
const router = useRouter();
const { operator } = storeToRefs(operatorStore);

const operatorSetupActions = [
  {
    id: "source",
    selector: markRaw(ActionFromSource),
    wizzard: defineAsyncComponent(() => import("@/components/setup/MultiSources/index.vue")),
    extraProps: {
      sources: [
        sources.GEOFOLIA,
        sources.MESPARCELLES,
        sources.TELEPAC,
        sources.CVI,
        sources.ANYGEO,
        ...(permissions.isOc ? [sources.RPG] : []),
      ],
    },
  },
];

useHead({
  title: `Importer un parcellaire - ${operator.nom}`,
});

async function handleRedirect(record) {
  await router.push(`/exploitations/${operator.numeroBio}/${record.record_id}`);
  toast.success(`Version créée aujourd'hui à ${hhmm(new Date())}`);
}
</script>

<template>
  <section class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li>
          <router-link class="fr-breadcrumb__link" :to="`/exploitations/${operator.numeroBio}`">{{
            operator.nom
          }}</router-link>
        </li>
        <li><a class="fr-breadcrumb__link" aria-current="page">Importer un parcellaire informatisé</a></li>
      </ol>
    </nav>

    <h1 class="fr-h1">Importer un parcellaire informatisé</h1>

    <OperatorSetupFlow
      :operator="operatorStore.operator"
      :actions="operatorSetupActions"
      with-stepper
      flow-id="source"
      @redirect="handleRedirect"
    >
      <template #introduction>
        <p class="fr-text--lg" v-if="permissions.isAgri">
          Nous vous demandons quelques informations lors d'une <em>première utilisation</em> de CartoBio.
        </p>
        <p class="fr-h6" v-if="permissions.isAgri">Choisir votre mode de création de parcellaire :</p>
      </template>
    </OperatorSetupFlow>
  </section>
</template>

<style scoped></style>
