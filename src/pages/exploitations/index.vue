<route lang="yaml">
meta:
  requiredRoles: ["agri"]
  seo:
    title: Mes exploitations
</route>

<template>
  <div class="fr-container fr-my-5w">
    <div class="fr-grid-row">
      <div class="fr-col-12">
        <h2 class="fr-h3">Sélectionner mon exploitation</h2>

        <div v-if="isLoading">
          <Spinner>Chargement des données…</Spinner>
        </div>

        <section class="fr-grid-row fr-grid-row--gutters" v-if="!isLoading && hasOperators">
          <article class="fr-col-12 fr-col-md-4" v-for="operator in operators" :key="operator.numeroBio">
            <div class="fr-card fr-card--horizontal">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <h4 class="fr-card__title">{{ operator.nom }}</h4>
                  <div class="fr-card__desc">
                    <ul class="list-unstyled">
                      <li v-if="operator.commune">
                        <strong>Siège</strong> : {{ operator.commune }} ({{ operator.departement }})
                      </li>
                      <li v-if="operator.denominationCourante && operator.denominationCourante !== operator.nom">
                        <b>Dénomination courante</b> : {{ operator.denominationCourante }}
                      </li>
                      <li v-if="operator.siret"><b>SIRET</b> : {{ operator.siret }}</li>
                      <li v-if="operator.numeroPacage"><b>PACAGE</b> : {{ operator.numeroPacage }}</li>
                      <li><b>Numéro Bio</b> : {{ operator.numeroBio }}</li>
                      <li><b>Date de début de conversion</b> : {{ operator.dateEngagement }}</li>
                    </ul>
                  </div>
                  <div class="fr-card__start">
                    <ul class="fr-tags-group">
                      <li>
                        <p class="fr-badge fr-badge--success fr-icon-medal-fill">vérifié</p>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="fr-card__footer">
                  <ul class="fr-btns-group fr-btns-group--inline-lg">
                    <li>
                      <router-link class="fr-btn" :to="`/exploitations/${operator.numeroBio}`">
                        Voir cette exploitation
                      </router-link>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </article>
        </section>

        <Pagination
          v-if="!isLoading && maxPage > 1"
          :currentPage
          :maxPage
          @change-page="(page) => (currentPage = page)"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, onMounted, ref, watch } from "vue";
import { getUserOperators } from "@/cartobio-api.js";
import { useRouter } from "vue-router";
import Spinner from "@/components/widgets/Spinner.vue";
import Pagination from "@/components/widgets/Pagination.vue";

const RESULTS_PER_PAGE = 10;

const router = useRouter();
const isLoading = ref(true);
const operators = ref([]);
const nbTotal = ref(0);
const currentPage = ref(1);

const hasOperators = computed(() => Boolean(operators.value.length));
const maxPage = computed(() => Math.ceil(nbTotal.value / RESULTS_PER_PAGE));

watch(currentPage, () => loadOperators());

onMounted(() => {
  loadOperators();
});

async function loadOperators() {
  isLoading.value = true;

  const res = await getUserOperators(RESULTS_PER_PAGE, (currentPage.value - 1) * RESULTS_PER_PAGE);
  if (res.nbTotal === 1 && res.operators.length === 1) {
    await router.push(`/exploitations/${res.operators[0].numeroBio}`);
  }

  operators.value = res.operators;
  nbTotal.value = res.nbTotal;
  isLoading.value = false;
}
</script>

<style scoped>
span[aria-selected="true"] {
  font-weight: bold;
}

.help span:not(:last-of-type)::after {
  content: ", ";
}

.list-unstyled {
  --ul-type: none;
  --ul-start: 0;
}
</style>
