<route lang="yaml">
  meta:
    requiredPermissions: ['canAddParcelle']
    seo:
      title: Ajouter une parcelle
</route>

<template>
  <section class="fr-container fr-py-9v">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <p>
          <router-link :to="backLink" class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-left-line">
            Retour Ã  l'exploitation
          </router-link>
        </p>

        <OperatorSummary :operator="record.operator" :record="recordStore.record" disable-actions />
        <FeatureAddFlow :back-link="backLink" @update="pendingChangesCollection = $event" />
      </div>

      <div class="fr-col-6">
        <MapContainer v-if="recordStore.isSetup" :options="{ interactive: true }" class="map" :bounds="mapBounds">
          <GeojsonLayer :style="baseStyle" name="base" />
          <GeojsonLayer :style="cadastreStyle" name="cadastre" />
          <GeojsonLayer :data="featureStore.collection" name="parcellaire-operateur" />
          <GeojsonLayer v-if="pendingChangesCollection" :data="pendingChangesCollection" name="pending-changes" :fill="{ 'fill-color': '#FDE2B5', 'fill-outline-color': '#000091', 'fill-opacity': 0.8 }" />
        </MapContainer>
        <SetupOverlay v-else>
          Parcellaire inconnu
        </SetupOverlay>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, shallowRef } from 'vue'
import bbox from '@turf/bbox'

import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import SetupOverlay from '@/components/Map/SetupOverlay.vue'
import OperatorSummary from '@/components/Operator/Summary.vue'
import FeatureAddFlow from '@/components/Features/AddFlow.vue'

import baseStyle from '@/map-styles/base.json'
import cadastreStyle from '@/map-styles/cadastre.json'

import { useFeaturesStore, usePermissions, useRecordStore } from '@/stores/index.js'

const props = defineProps({
  id: {
    type: String,
    required: true
  }
})

const featureStore = useFeaturesStore()
const recordStore = useRecordStore()
const permissions = usePermissions()
const record = recordStore.record

const pendingChangesCollection = shallowRef(null)
const mapBounds = computed(() => {
  if (pendingChangesCollection.value) {
    return bbox(pendingChangesCollection.value)
  }

  if (recordStore.isSetup) {
    return bbox(featureStore.collection)
  }

  return []
})

const backLink = computed(() => permissions.isOc ?
    `/certification/exploitations/${props.id}` : '/exploitation/parcellaire')
</script>

<style>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: sticky;
  top: 0;
  width: 100%;
}
</style>
