<route lang="yaml">
meta:
  requiredPermissions: ['canAddParcelle']
  seo:
    title: Ajouter une parcelle par dessin
</route>

<template>
  <section class="fr-container fr-py-9v">
        <p>
          <router-link :to="`/exploitations/${id}/ajout-parcelle`" class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-left-line">
            Retour à l'ajout de parcelles
          </router-link>
        </p>

        <ParcellaireState :state="recordStore.record.certification_state" :date="recordStore.record.created_at" />
        <h2 class="fr-h4 fr-my-3v">{{ recordStore.record.operator.nom }}</h2>
        <h3 class="fr-h5 fr-my-3v">Ajouter une parcelle par dessin</h3>

        <CommuneSelect @feature="centerCommune" class="fr-mt-3v fr-mb-6v" style="max-width: 20.5rem" />

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-9">
        <MapContainer v-if="recordStore.isSetup" :options="{ interactive: true }" class="map" :bounds="mapBounds" ref="map" >
          <LayerSelector v-model:fond="fond" v-model:classification="showClassification" v-model:cadastre="showCadastre" v-model:ilots="showIlots" />
          <GeojsonLayer v-if="fond === 'plan'" :style="baseStyle" name="base" :before="showCadastre ? 'cadastre' : showClassification ? 'surroundings' : 'parcellaire-operateur'" />
          <GeojsonLayer v-if="fond === 'satellite'" :style="satelliteStyle" name="satellite" :before="showCadastre ? 'cadastre' : showClassification ? 'surroundings' : 'parcellaire-operateur'" />
          <GeojsonLayer v-if="showCadastre" :style="cadastreStyle" name="cadastre" before="parcellaire-operateur" />
          <GeojsonLayer v-if="showClassification" :style="surroundingsStyle" name="surroundings" before="parcellaire-operateur" />

          <FeaturesLayer :show-numeros-ilots="showIlots" />
        </MapContainer>
      </div>
      <div class="fr-col-3">
        <div class="controls">
          <p><b>Mode d'emploi</b></p>
          <ol>
            <li><b>Dessiner&nbsp;:</b> Cliquez sur la carte pour commencer à tracer la parcelle et
              cliquez sur le premier point pour clore le tracé.</li>
            <li><b>Modifier&nbsp;:</b> Cliquez sur votre parcelle nouvellement dessinée et déplacez les points.</li>
            <li><b>Enregistrer&nbsp;:</b> Cliquez sur “Enregistrer le tracé”.</li>
          </ol>
          <button
              class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-delete-bin-fill fr-mb-4w"
              @click="showResetModal = true"
              :disabled="feature === null"
          >
            Supprimer le tracé</button>
          <div v-if="error" class="fr-alert fr-alert--error">
            <p>{{ error }}</p>
          </div>
          <button
              class="fr-btn fr-btn--primary fr-btn--icon-left fr-icon-save-fill"
              @click="showDetailsModal = true"
              :disabled="feature === null || error !== ''">
            Enregistrer le tracé
          </button>
        </div>
      </div>
    </div>
  </section>

  <Teleport to="body">
    <Component :is="editForm" v-if="showDetailsModal" :feature="feature" @submit="saveFeature" @close="showDetailsModal = false" icon="fr-icon-add-line" data-content-name="Modale de confirmation d'ajout">
      <template #title>Créer ma parcelle</template>
    </Component>
    <Modal v-if="showResetModal" @close="showResetModal = false" icon="fr-icon-delete-bin-fill">
      <template #title>Suppression de contour</template>
      <template #default>
        <div class="fr-alert fr-alert--error">Vous êtes sur le point de supprimer votre tracé</div>
        <p class="fr-mt-3w">Voulez-vous poursuivre cette action&nbsp;?</p>
      </template>
      <template #footer>
        <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--right fr-btns-group--icon-left">
          <li><button class="fr-btn fr-btn--secondary" @click="showResetModal = false">Annuler</button></li>
          <li><button class="fr-btn fr-btn--primary fr-icon-delete-bin-fill" @click="reset">Supprimer</button></li>
        </ul>
      </template>
    </Modal>
  </Teleport>
</template>

<script setup>
import { computed, markRaw, onMounted, ref, toRaw, watch } from 'vue'
import bbox from "@turf/bbox"
import intersect from "@turf/intersect"
import { TerraDraw, TerraDrawMapLibreGLAdapter, TerraDrawPolygonMode, TerraDrawSelectMode } from "terra-draw"

import baseStyle from "@/map-styles/base.json"
import MapContainer from "@/components/Map/MapContainer.vue"
import GeojsonLayer from "@/components/Map/GeojsonLayer.vue"
import { useFeaturesStore, usePermissions, useRecordStore } from "@/stores/index.js"
import ParcellaireState from "@/components/Certification/State.vue"
import CommuneSelect from "@/components/Forms/CommuneSelect.vue"
import CertificationBodyEditForm from "@/components/Features/SingleItemCertificationBodyForm.vue"
import OperatorEditForm from "@/components/Features/SingleItemOperatorForm.vue"
import { submitNewParcelle } from "@/cartobio-api.js"
import { statsPush } from "@/stats.js"
import { useRouter } from "vue-router"
import Modal from "@/components/Modal.vue"
import toast from "@/components/toast.js"
import cadastreStyle from "@/map-styles/cadastre.json"
import surroundingsStyle from "@/map-styles/surroundings.json"
import LayerSelector from "@/components/Map/LayerSelector.vue"
import satelliteStyle from "@/map-styles/satellite.json"
import { featureName } from "@/components/Features/index.js"
import FeaturesLayer from "@/components/Map/FeaturesLayer.vue"

const props = defineProps({
  id: {
    type: String,
    required: true
  }
})

const recordStore = useRecordStore()
const featuresStore = useFeaturesStore()
const permissions = usePermissions()
const router = useRouter()

const mapBounds = computed(() => {
  if (recordStore.isSetup) {
    return bbox(featuresStore.collection)
  }

  return []
})

const map = ref(null) // MapContainer instance
const fond = ref('satellite')
const showClassification = ref(false)
const showCadastre = ref(false)
const showIlots = ref(true)
let draw // TerraDraw instance

/**
 * @type {import('vue').Ref<import('terra-draw').Feature>}
 */
const feature = ref(null)
const error = ref('')

// Flow state
const showDetailsModal = ref(false)
const showResetModal = ref(false)
const editForm = computed(() => markRaw(permissions.isOc ? CertificationBodyEditForm : OperatorEditForm))


const centerCommune = (feature) => {
  map.value.map.flyTo({
    center: feature.geometry.coordinates,
  })
}

const reset = () => {
  showResetModal.value = false
  feature.value = null
  draw.clear()
  draw.setMode('polygon')
  error.value = ''
}


onMounted(() => {
  draw = new TerraDraw({
    adapter: new TerraDrawMapLibreGLAdapter({ map: map.value.map }),
    modes: [
      new TerraDrawPolygonMode({
        allowSelfIntersections: false,
        styles: {
          fillColor: "#000091",
          fillOpacity: 0.1,
          outlineColor: "#000091",
          outlineWidth: 2,
          closingPointColor: "#000091",
        }
      }),
      new TerraDrawSelectMode({
        styles: {
          selectedPolygonColor: "#000091",
          selectedPolygonFillOpacity: 0.1,
          selectedPolygonOutlineColor: "#000091",
          selectedPolygonOutlineWidth: 2,
          selectionPointColor: "#000091",
          midPointColor: "#000091",
        },
        flags: {
          polygon: {
            feature: {
              draggable: true,
              rotateable: true,
              scaleable: true,
              selfIntersectable: false,
              coordinates: {
                midpoints: true,
                draggable: true,
                deletable: true
              }
            }
          }
        }
      })
    ],
  })

  draw.on("finish", () => {
    feature.value = draw.getSnapshot()[0]
    feature.value.properties.cultures = [{ CPF: '', id: crypto.randomUUID() }]
    feature.value.id = 1

    if (draw.getMode() === "polygon") {
      draw.setMode("select")
    }
  })
  draw.start()

  map.value.map.on("click", () => {
    if (draw.getMode() === "static") {
      draw.setMode("polygon")
    }
  })
})

watch(feature, (feature) => {
  if (feature === null) return

  if (featuresStore.collection.features.some(f => intersect(toRaw(f), feature))) {
    error.value = 'Le contour que vous avez tracé recoupe l’une de vos parcelles existantes. Vous ne pouvez pas enregistrer ce contour.'
  } else {
    error.value = ''
  }
})

async function saveFeature ({ properties }) {
  feature.value.properties = { ...feature.value.properties, ...properties }
  const record = await submitNewParcelle({ recordId: recordStore.record.record_id }, feature.value)
  const newId = record.parcelles.features.at(-1).id
  featuresStore.setAll(record.parcelles.features)

  showDetailsModal.value = false
  statsPush(['trackEvent', 'Parcelles', 'Ajout par dessin (sauvegarde)'])
  await router.push(permissions.isOc ? `/certification/exploitations/${props.id}` : `/exploitations/${props.id}`)

  toast.success(`Parcelle « ${featureName(feature.value)} » ajoutée.`, 'Voir la parcelle', () => {
    featuresStore.select(newId)
  })
}
</script>

<style>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: sticky;
  top: 0;
  width: 100%;
}

.controls {
  position: relative;
  height: 100%;
}

.controls > *:nth-last-child(1) {
  position: absolute;
  bottom: 0;
  left: 0;
}
</style>
