<route lang="yaml">
  meta:
    requiredRoles: ['agri', 'certif', 'audit']
    seo:
      title: Liste des parcellaires téléchargés pour une utilisation hors-ligne
  </route>

<script setup>
import { computed } from "vue"
import { usePermissions } from "@/stores/permissions.js"
import { useCartoBioStorage } from "@/stores/storage.js"

const storage = useCartoBioStorage()
const permissions = usePermissions()

const storedRecords = computed(() => {
  return Array.from((function* records() {
    for (const [, { operator, records }] of Object.entries(storage.operators)) {
      for (const record of records) {
        if (storage.records[record.record_id]) {
          yield {
            operator,
            record
          }
        }
      }
    }
  })()).sort((a, b) => {
    if (a.operator.numeroBio !== b.operator.numeroBio) {
      return a.operator.nom.localeCompare(b.operator.nom)
    }

    return new Date(b.record.created_at) - new Date(a.record.created_at)
  })
})
</script>

<template>
  <div class="fr-container fr-pb-2w">
    <nav role="navigation" class="fr-breadcrumb fr-mb-2w">
      <ol class="fr-breadcrumb__list">
        <li><router-link class="fr-breadcrumb__link" :to="permissions.startPage">Exploitations</router-link></li>
        <li><a class="fr-breadcrumb__link" aria-current="page">Parcellaires téléchargés</a></li>
      </ol>
    </nav>
    <h1 class="fr-h3">Parcellaires téléchargés</h1>
    <div class="fr-table fr-table--bordered">
      <table>
        <thead>
        <tr>
          <th>Nom de l'exploitation</th>
          <th>Nom de version</th>
          <th>Date d'audit</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr
            v-for="{operator, record} in storedRecords"
            :key="record.record_id"
            @click="$router.push(`/exploitations/${operator.numeroBio}/${record.record_id}/`)"
        >
          <td>{{ operator.nom }}</td>
          <td>{{ record.version_name }}</td>
          <td>{{ record.audit_date }}</td>
          <td>
            <button
                type="button"
                class="fr-btn fr-btn--tertiary-no-outline fr-icon-close-circle-fill"
                @click.stop.prevent="storage.clearRecord(record.record_id)"
            >Supprimer des téléchargements</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<style scoped>
.fr-table table {
  width: 100%;
  display: table;

  & tbody tr:hover,
  & tbody button:hover {
    cursor: pointer;
    background-color: var(--background-alt-blue-france-hover);
  }
}
</style>
