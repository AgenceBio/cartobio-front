<route lang="yaml">
meta:
  requiresAuth: true
  requiredRoles: ['oc']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <OperatorSummary :operator="record.operator" :record="record" />
        <FeaturesTable v-if="!needsSetup" :record="record" :operator="record.operator" :features="record.parcelles" />
      </div>

      <div class="fr-col-6">
        <MapContainer :options="{ interactive: false }" class="map" :bounds="mapBounds" @load="setupWatchers">
          <GeojsonLayer :data="record.parcelles" name="parcellaire-operateur" />
          <SetupOverlay v-if="needsSetup">
            Parcellaire inconnu
          </SetupOverlay>
        </MapContainer>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, toRefs, readonly } from 'vue'
import { getOperatorParcelles } from '@/cartobio-api'
import bbox from '@turf/bbox'

import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import SetupOverlay from '@/components/Map/SetupOverlay.vue'
import OperatorSummary from '@/components/Operator/Summary.vue'
import FeaturesTable from '@/components/Features/Table.vue'

import store from '@/store.js'
import { useFeaturesStore } from '@/stores/features.js'

const props = defineProps({
  id: {
    type: String,
    required: true
  }
})

const { currentUser } = toRefs(store.state)
const record = await getOperatorParcelles(props.id)
const mapBounds = computed(() => bbox(record.parcelles))
const needsSetup = computed(() => record.parcelles.features.length === 0 && !record.metadata.source)

const featureStore = useFeaturesStore()
featureStore.setAll(readonly(record.parcelles.features))

function setupWatchers (map) {
  featureStore.bindMaplibreFeatureState({ map, source: 'parcellaire-operateur' })
  featureStore.bindMaplibreInteractions({ map, layer: 'parcellaire-operateur-geometry' })
}
</script>

<style>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: sticky;
  top: 0;
  width: 100%;
}
</style>
