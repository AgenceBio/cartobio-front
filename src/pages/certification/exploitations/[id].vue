<route lang="yaml">
meta:
  requiredRoles: ['oc']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <p>
          <router-link to="/certification/exploitations" class="fr-btn fr-btn--tertiary-no-outline fr-btn--icon-left fr-icon-arrow-left-line">
            Retour à mes clients
          </router-link>
        </p>

        <OperatorSummary :operator="record.operator" :record="recordStore.record" />
        <CertificationSummary v-if="!needsSetup" :operator="record.operator" :record="recordStore.record" :features="featureStore.collection" :validation-rules="validationRules" />
        <FeaturesTable v-if="!needsSetup" :operator="record.operator" :features="featureStore.collection" :edit-form="EditForm" :validation-rules="validationRules" :mass-actions="massActions" />
        <OperatorSetup v-if="needsSetup" :operator="record.operator" />
      </div>

      <div class="fr-col-6 fr-col--map" v-if="!needsSetup">
        <div class="sticky-top" :class="{ 'sticky-top--force-height': isMapFullSize }">
          <div :class="{ 'full-size-map fr-card fr-card--shadow fr-p-2w': isMapFullSize }">
            <MapContainer :style="mapStyles" class="map" :class="{ 'map--full-size': isMapFullSize }" :mode="isMapFullSize ? 'fullsize' : 'compact'" :bounds="mapBounds" @load="setupWatchers">
              <GeojsonLayer :data="featureStore.collection" name="parcellaire-operateur" />
              <template #legend>
                <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm fr-m-3w full-size-button" @click="isMapFullSize = !isMapFullSize">
                  <span v-if="!isMapFullSize" class="fr-fi-arrow-left-s-line-double fr-fi--sm fr-mr-1w"></span>
                  {{ isMapFullSize ? "Réduire la carte" : "Agrandir la carte" }}
                  <span v-if="isMapFullSize" class="fr-fi-arrow-right-s-line-double fr-fi--sm fr-ml-1w"></span>
                </button>
                <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm fr-m-3w fr-btn--icon-left fr-icon-compass-3-line center-button" @click="focusOnOriginalBbox">
                  Centrer sur l'exploitation
                </button>
                <SurroundingsLegend v-if="showSurroundings" />
              </template>
            </MapContainer>
            <div class="fr-toggle">
              <input type="checkbox" v-model="showSurroundings" class="fr-toggle__input" id="toggle-surroundings">
              <label class="fr-toggle__label" for="toggle-surroundings">Parcelles environnantes</label>
            </div>
          </div>
        </div>
      </div>
      <div class="fr-col-6" v-else>
        <SetupOverlay>
          Parcellaire inconnu
        </SetupOverlay>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, markRaw, readonly, ref, shallowRef } from 'vue'
import { getOperatorParcelles } from '@/cartobio-api'
import bbox from '@turf/bbox'

import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import SetupOverlay from '@/components/Map/SetupOverlay.vue'
import OperatorSummary from '@/components/Operator/Summary.vue'
import CertificationSummary from '@/components/Certification/Summary.vue'
import FeaturesTable from '@/components/Features/Table.vue'
import EditForm from '@/components/Features/SingleItemCertificationBodyForm.vue'
import OperatorSetup from '@/components/Certification/OperatorSetup/index.vue'
import CultureTypeModal from '@/components/Operator/CultureTypeModal.vue'
import EngagementDateModal from '@/components/Certification/EngagementDateModal.vue'
import EngagementLevelModal from '@/components/Certification/EngagementLevelModal.vue'

import { useFeaturesStore, useRecordStore } from '@/stores/index.js'
import { AUDITOR_RULES } from '@/referentiels/ab.js'
import { all as mergeAll } from "deepmerge";
import baseStyle from "@/map-styles/base.json";
import surroundingsStyle from "@/map-styles/surroundings.json";
import cadastreStyle from "@/map-styles/cadastre.json";
import SurroundingsLegend from "@/components/Map/SurroundingsLegend.vue";

const props = defineProps({
  id: {
    type: String,
    required: true
  }
})

const featureStore = useFeaturesStore()
const recordStore = useRecordStore()
const mapRef = shallowRef(null);
const showSurroundings = ref(false);
const isMapFullSize = ref(false)
const mapStyles = computed(() => {
  if (showSurroundings.value) {
    return mergeAll([
      baseStyle,
      surroundingsStyle,
      cadastreStyle,
    ])
  }

  return baseStyle
})

const validationRules = readonly({
  rules: AUDITOR_RULES,
  success: 'fr-icon--neutral',
  error: 'fr-icon--warning'
})

const massActions = [
  { label: 'Modifier les cultures', component: markRaw(CultureTypeModal) },
  { label: 'Ajouter une date d\'engagement', component: markRaw(EngagementDateModal) },
  { label: 'Modifier le niveau de conversion', component: markRaw(EngagementLevelModal) },
]

const record = await getOperatorParcelles(props.id)

recordStore.update(record)
featureStore.setAll(record.parcelles.features)

const needsSetup = computed(() => featureStore.collection.features.length === 0 && !record.metadata.source)
const mapBounds = computed(() => needsSetup.value ? [] : bbox(featureStore.collection))

function focusOnOriginalBbox () {
  zoomInto(featureStore.collection, { maxZoom: 12 })
}

function zoomInto (featureOrFeatureCollection, { maxZoom }) {
  const bounds = bbox(featureOrFeatureCollection)
  const { center, zoom, bearing } = mapRef.value.cameraForBounds(bounds, { padding: 50, maxZoom }) ?? {}
  if (center && zoom) {
    mapRef.value.flyTo({ center, zoom, bearing })
  }
}

function setupWatchers (map) {
  mapRef.value = map;
  featureStore.bindMaplibreFeatureState({ map, source: 'parcellaire-operateur' })
  featureStore.bindMaplibreInteractions({ map, layer: 'parcellaire-operateur-geometry' })
}
</script>

<style>
.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: relative;
}

.map--full-size {
    height: calc(90vh - 5rem);
}

.fr-col--map {
    position: relative;
}

.sticky-top {
    width: 100%;
    position: sticky;
    top: 2rem;
    z-index: 999;
}

.sticky-top--force-height {
    height: 90vh;
}

.full-size-map {
    width: 180%;
    position: absolute;
    right: 0;
    background: #fff;
    height: 90vh;
}

.full-size-button {
    top: 0;
    left: 0;
    position: absolute;
    background: #fff;
}

.center-button {
    position: absolute;
    top: 0;
    right: 0;
    background: #fff;
}
</style>
