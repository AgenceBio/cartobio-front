<route lang="yaml">
meta:
  requiredRoles: ["certif", "audit"]
  skipLinks:
    Recherche: "#search"
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-9v">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">Exploitations {{ user.organismeCertificateur.nom }}</h1>

        <form
          @submit.prevent="updateQuery({ search: userInput, page: 1 })"
          class="fr-search-bar fr-search-bar--lg"
          id="header-search"
          role="search"
        >
          <label class="fr-label" for="search"> Recherche par nom d'exploitation, SIRET ou numéro bio </label>
          <input
            class="fr-input"
            placeholder="Chercher par nom d'opérateur, SIRET ou numéro bio…"
            minlength="1"
            autocomplete="cartobio-operator"
            v-model.trim="userInput"
            autofocustype="search"
            id="search"
            :disabled="!isOnline"
          />
          <button class="fr-btn" type="submit" title="Rechercher" :disabled="isSearching || !isOnline">
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12">
        <Conflict v-if="storage.conflicts.size || storage.dateConflicts.size" />

        <div class="fr-table fr-table--bordered fr-table--no-caption table-data">
          <table class="fr-mb-6v" aria-describedby="operator-summary-global">
            <caption>
              Opérateurs
              {{
                user.organismeCertificateur.nom
              }}
            </caption>
            <colgroup>
              <col width="45%" />
              <col width="15%" />
              <col width="15%" />
              <col width="30%" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col" :aria-sort="sortAttribute('nom')" class="table-header-nom">
                  <TableSort
                    :show-control="showOptionalControl"
                    code="nom"
                    v-model="sortOrder"
                    @update:modelValue="(v) => updateQuery({ ...v, page: 1 })"
                    >Exploitation</TableSort
                  >
                </th>
                <th
                  scope="col"
                  :aria-sort="sortAttribute('engagement_date')"
                  class="table-header-engagement_date fr-text--align-right"
                >
                  <TableSort
                    :show-control="showOptionalControl"
                    code="engagement_date"
                    v-model="sortOrder"
                    @update:modelValue="(v) => updateQuery({ ...v, page: 1 })"
                    >Début de conversion</TableSort
                  >
                </th>
                <th
                  scope="col"
                  :aria-sort="sortAttribute('audit_date')"
                  class="table-header-audit_date fr-text--align-right"
                >
                  <TableSort
                    code="audit_date"
                    v-model="sortOrder"
                    @update:modelValue="(v) => updateQuery({ ...v, page: 1 })"
                    >Date de l'audit</TableSort
                  >
                </th>
                <th scope="col" :aria-sort="sortAttribute('statut')" class="table-header-statut fr-text--align-right">
                  <TableSort
                    code="statut"
                    v-model="sortOrder"
                    @update:modelValue="(v) => updateQuery({ ...v, page: 1 })"
                    >Statut</TableSort
                  >
                </th>
              </tr>
            </thead>
            <tbody aria-live="polite">
              <tr v-if="isSearching">
                <td colspan="4" class="center">
                  <Spinner>Chargement des données…</Spinner>
                </td>
              </tr>
              <tr v-else-if="error">
                <td colspan="4">
                  <div class="fr-alert fr-alert--warning" role="alert">
                    <p>{{ error }}</p>
                  </div>
                </td>
              </tr>
              <tr v-else-if="!isSearching && operators.length === 0">
                <td colspan="4">
                  <div class="fr-alert fr-alert--warning" role="alert">
                    <h3 class="fr-alert__title">Aucune exploitation trouvée</h3>

                    <p>Est-ce qu'elle est déclarée sous ce nom sur le portail de notification de l'Agence Bio ?</p>
                  </div>
                </td>
              </tr>
              <tr
                v-for="{
                  record_id,
                  audit_date,
                  certification_date_debut,
                  certification_date_fin,
                  certification_state,
                  ...operator
                } in operators"
                :key="record_id"
                class="operator-record fr-enlarge-link"
              >
                <td>
                  <router-link :to="`/exploitations/${operator.numeroBio}`" class="fr-link">
                    {{ operator.nom }} </router-link
                  ><br />
                  <span class="fr-hint-text">{{ operator.commune }}, {{ operator.codePostal }}</span>
                </td>
                <td class="fr-text--align-right">
                  <time :datetime="operator.dateEngagement" v-if="operator.dateEngagement">{{
                    monthYearDateFormat(operator.dateEngagement)
                  }}</time>
                  <span aria-hidden v-else>-</span>
                </td>
                <td class="fr-text--align-right">
                  <time :datetime="audit_date" v-if="audit_date">{{ monthYearDateFormat(audit_date) }}</time>
                  <span aria-hidden v-else>-</span>
                </td>
                <td class="fr-text--align-right badges">
                  <ParcellaireState
                    :record="{ certification_date_debut, certification_state, audit_date }"
                    :show-date="false"
                  />
                  <span v-if="certification_date_fin" class="fr-hint-text">
                    Du {{ dateFormat(certification_date_debut) }} au {{ dateFormat(certification_date_fin) }}
                  </span>
                  <span aria-hidden class="fr-ml-1w fr-icon-arrow-right-line fr-icon--sm" />
                </td>
              </tr>
            </tbody>
            <tfoot v-if="!isSearching && hasResults && isOnline">
              <tr>
                <td class="results-total">{{ operators.length }} sur {{ pagination.total }} résultats</td>
                <td colspan="3">
                  <Pagination
                    :currentPage="currentPage"
                    :maxPage="pagination.page_max"
                    @changePage="updateQuery({ page: $event })"
                  />
                </td>
              </tr>
            </tfoot>
          </table>

          <p id="operators-summary-global" class="fr-sr-only">
            Liste paginée des versions les plus récentes de parcellaires de {{ pagination.total }} opérateurs. La
            première colonne contient le nom de l'opérateur ; la seconde, la date de début de conversion (si applicable)
            ; la troisième, la date d'audit ; la quatrième et dernière colonne, le statut de certification.
          </p>

          <p class="fr-mt-3w">
            <span class="fr-icon fr-icon-questionnaire-fill fr-mr-1w" aria-hidden />

            Les noms d'exploitations vous semblent incorrects&nbsp;?
            <a href="https://notification.agencebio.org/" target="_blank"
              >Modifiez-les sur le Portail de Notification<lien-externe
            /></a>
            de l'Agence Bio.
          </p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, ref, watch } from "vue";
import { storeToRefs } from "pinia";
import { useRoute, useRouter } from "vue-router";
import { AxiosError } from "axios";

import ParcellaireState from "@/components/records/State.vue";
import Spinner from "@/components/widgets/Spinner.vue";
import TableSort from "@/components/widgets/TableSort.vue";
import { monthYearDateFormat, dateFormat } from "@/utils/dates.js";

import { searchOperators } from "@/cartobio-api.js";
import { useUserStore } from "@/stores/user.js";
import { useOnline } from "@vueuse/core";
import { useCartoBioStorage } from "@/stores/storage.js";
import Conflict from "@/components/versions/Conflict.vue";
import Pagination from "@/components/widgets/Pagination.vue";

const props = defineProps({
  search: {
    type: String,
    default: "",
  },
  page: {
    type: String,
    default: "1",
    validator: (value) => parseInt(value, 10) > 0,
  },
  sort: {
    type: String,
    default: "audit_date",
    validator: (value) => ["nom", "engagement_date", "audit_date", "statut"].includes(value),
  },
  order: {
    type: String,
    default: "desc",
    validator: (value) => ["asc", "desc"].includes(value),
  },
});

const userStore = useUserStore();
const storage = useCartoBioStorage();
const router = useRouter();
const route = useRoute();
const isOnline = useOnline();

const { startPage, user } = storeToRefs(userStore);

const error = ref("");
const isSearching = ref(false);
const searchResults = ref([]);
const operators = computed(() =>
  isOnline.value
    ? searchResults.value
    : Object.entries(storage.operators)
        .map(([, { records, operator }]) => ({ ...operator, ...records[0] }))
        .sort((a, b) =>
          (a[sortOrder.value.sort] < b[sortOrder.value.sort]) ^ (sortOrder.value.order === "desc") ? -1 : 1,
        ),
);

// controlled by the form
const userInput = ref(props.search);
const searchInput = computed(() => props.search ?? "");
const currentPage = computed(() => parseInt(props.page, 10));
const sortOrder = ref({
  sort: props.sort,
  order: props.order,
});

const pagination = ref({
  total: 0,
  page: props.page,
  page_max: 1,
});

const showOptionalControl = computed(() => Boolean(searchInput.value));
const hasResults = computed(() => searchResults.value.length > 0);

const sortAttribute = (sort) => {
  if (sort !== sortOrder.value.sort) {
    return null;
  }

  return sortOrder.value.order === "asc" ? "ascending" : "descending";
};

function updateQuery(query) {
  router.replace({
    path: startPage.value,
    query: {
      ...route.query,
      ...Object.entries(query)
        .filter(([, value]) => value !== undefined)
        .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {}),
    },
  });
}

/**
 * @param {Error} error
 * @return {Boolean}
 */
function isNetworkError(error) {
  return (
    error.name === "AxiosError" &&
    [AxiosError.ETIMEDOUT, AxiosError.ECONNABORTED, AxiosError.ERR_NETWORK].includes(error.code)
  );
}

async function doSearch(input, page, sort, order) {
  error.value = "";
  searchResults.value = [];

  if (!isOnline.value) return;

  isSearching.value = true;
  try {
    const results = await searchOperators({ input: input.trim(), page, sort, order });

    pagination.value = results.pagination;
    searchResults.value = results.records;
  } catch (e) {
    pagination.value = {
      total: 0,
      page: props.page,
      page_max: 1,
    };

    if (isNetworkError(e)) {
      error.value = "Une erreur de réseau est survenue. Vérifiez votre connexion internet.";
    } else {
      throw e;
    }
  } finally {
    isSearching.value = false;
  }
}

watch(
  [searchInput, currentPage, sortOrder],
  () => doSearch(searchInput.value, currentPage.value, sortOrder.value.sort, sortOrder.value.order),
  { immediate: true },
);
watch(
  () => route.query.sort,
  (v) => (sortOrder.value.sort = v ?? "audit_date"),
);
watch(
  () => route.query.order,
  (v) => (sortOrder.value.order = v ?? "desc"),
);
watch(
  () => route.query.search,
  (search) => {
    userInput.value = (search || "").trim();

    if (!searchInput.value && ["nom", "engagement_date"].includes(sortOrder.value.sort)) {
      sortOrder.value = { sort: "audit_date", order: "desc" };
    }
  },
  { immediate: true },
);
</script>

<style scoped>
.center {
  text-align: center;
}

.fr-btns-group--pagination {
  justify-content: flex-end;
}

.fr-table table {
  thead th {
    white-space: nowrap;
  }

  tfoot {
    background-color: var(--background-alt-grey);
    background-size: 100% 1px;
    background-repeat: no-repeat;
    background-position: top;
    background-image: linear-gradient(0deg, #3a3a3a, #3a3a3a);
  }
}

.fr-enlarge-link:hover {
  background-color: var(--background-alt-blue-france-hover) !important;
}
.fr-enlarge-link:active {
  background-color: var(--light-background-action-low-blue-france) !important;
}

.results-title {
  font-style: italic;
  color: var(--text-mention-grey);
  line-height: 1.5rem;
  margin-bottom: 0.5rem;
}

.fr-link {
  font-weight: bold;
}
.fr-text--align-right {
  text-align: right !important;
}
.badges span {
  vertical-align: middle;

  &.fr-icon-arrow-right-line {
    @media (width < 48em /* md */) {
      display: none;
    }
  }
}

[aria-disabled="true"] {
  opacity: 0.5;
  pointer-events: none;
  cursor: wait;
}

.fr-alert--waiting::before {
  mask-image: url(@gouvfr/dsfr/icons/system/time-fill.svg);
}
</style>
