<route lang="yaml">
meta:
  requiresAuth: true
  requiredRoles: ['oc']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">Exploitations {{ currentCertificate.organisme }}</h1>

        <form @submit.prevent="doSearch" class="fr-search-bar fr-search-bar--lg" id="header-search" role="search">
          <label class="fr-label" for="search-input">
              Recherche
          </label>
          <input class="fr-input" placeholder="Nom de l'exploitation recherchée…" minlength="3" autocomplete="cartobio-operator" v-model="operatorName" required autofocustype="search" id="search-input">
          <button class="fr-btn" title="Rechercher" :disabled="isSearching">
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12" v-if="operators.length">
        <div :aria-disabled="isSearching" class="fr-table fr-table--bordered fr-table--no-caption">
          <table>
            <caption>Liste des exploitations</caption>
            <colgroup>
              <col width="50%" />
              <col width="15%" />
              <col width="15%" />
              <col width="20%" />
            </colgroup>
            <thead>
              <th scope="col">Exploitation</th>
              <th scope="col" class="fr-text--align-right">Date d'engagement</th>
              <th scope="col" class="fr-text--align-right">Parcellaire</th>
              <th scope="col" class="fr-text--align-right">Actions</th>
            </thead>
            <tbody>
              <tr v-for="item in operators" :key="item.id">
                <th>{{ item.nom }}</th>
                <td class="fr-text--align-right">{{ monthYearDateFormat(item.dateEngagement) }}</td>
                <td class="fr-text--align-right"><ParcellaireState :record="item" /></td>
                <td class="fr-text--align-right">
                  <router-link :to="`/certification/exploitations/${item.id}`" class="fr-link fr-fi-arrow-right-line fr-link--icon-right">Voir le parcellaire</router-link>
                </td>
              </tr>
            </tbody>
          </table>

          <p class="fr-mt-3w">
            <span class="fr-icon fr-icon-questionnaire-fill fr-mr-1w" aria-hidden />

            Les noms d'exploitations vous semblent incorrects&nbsp;?
            <a href="https://notification.agencebio.org/" target="_blank">Modifiez-les sur le Portail de Notification</a>
            de l'Agence Bio.
          </p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, toRefs, ref } from 'vue'
import ParcellaireState from '@/components/Certification/State.vue'

import store from '@/store.js'
import { searchOperators } from '@/cartobio-api.js'
import { monthYearDateFormat } from '@/components/dates.js'

const { currentUser } = toRefs(store.state)
const operatorName = ref('')

const isSearching = ref(false)
const operators = ref([])

const currentCertificate = computed(() => currentUser.value.certificats.at(-1))

async function doSearch () {
  isSearching.value = true
  const { operators: results } = await searchOperators(operatorName.value.trim())

  operators.value = results
  isSearching.value = false
}
</script>

<style>
.fr-table table {
  display: table;
}
.fr-text--align-right {
  text-align: right !important;
}

[aria-disabled="true"] {
  opacity: .5;
  pointer-events: none;
  cursor: wait;
}
</style>
