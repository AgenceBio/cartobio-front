<route lang="yaml">
meta:
  requiredRoles: ['certif', 'audit']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-9v">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">Exploitations {{ user.organismeCertificateur.nom }}</h1>

        <form @submit.prevent="updateQuery({ search: userInput, page: 1 })" class="fr-search-bar fr-search-bar--lg" id="header-search" role="search">
          <label class="fr-label" for="search-input">
            Recherche par nom d'exploitation, SIRET ou numéro bio
          </label>
          <input class="fr-input" placeholder="Chercher par nom d'opérateur, SIRET ou numéro bio…" minlength="1" autocomplete="cartobio-operator" v-model.trim="userInput" autofocustype="search" id="search-input">
          <button class="fr-btn" type="submit" title="Rechercher" :disabled="isSearching">
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12">
        <div class="fr-table fr-table--bordered">
          <table>
            <colgroup>
              <col width="45%" />
              <col width="15%" />
              <col width="15%" />
              <col width="30%" />
            </colgroup>
            <thead>
              <th scope="col" :aria-sort="sortAttribute('nom')" class="table-header-nom"><TableSort :show-control="showOptionalControl" code="nom" v-model="sortOrder" @update:modelValue="v => updateQuery({ ...v, page: 1 })">Exploitation</TableSort></th>
              <th scope="col" :aria-sort="sortAttribute('engagement_date')" class="table-header-engagement_date fr-text--align-right"><TableSort :show-control="showOptionalControl" code="engagement_date" v-model="sortOrder" @update:modelValue="v => updateQuery({ ...v, page: 1 })">Début de conversion</TableSort></th>
              <th scope="col" :aria-sort="sortAttribute('audit_date')" class="table-header-audit_date fr-text--align-right"><TableSort code="audit_date" v-model="sortOrder" @update:modelValue="v => updateQuery({ ...v, page: 1 })">Date de l'audit</TableSort></th>
              <th scope="col" :aria-sort="sortAttribute('statut')" class="table-header-statut fr-text--align-right"><TableSort code="statut" v-model="sortOrder" @update:modelValue="v => updateQuery({ ...v, page: 1 })">Statut</TableSort></th>
            </thead>
            <tbody>
              <tr v-if="isSearching">
                <td colspan="4" class="center">
                  <Spinner>Chargement des données…</Spinner>
                </td>
              </tr>
              <tr v-else-if="error">
                <td colspan="4">
                  <div class="fr-alert fr-alert--warning" role="alert">
                    <p>{{ error }}</p>
                  </div>
                </td>
              </tr>
              <tr v-else-if="!isSearching && searchRecords.length === 0">
                <td colspan="4">
                  <div class="fr-alert fr-alert--warning" role="alert">
                    <h3 class="fr-alert__title">Aucune exploitation trouvée</h3>

                    <p>Est-ce qu'elle est déclarée sous ce nom sur le portail de notification de l'Agence Bio ?</p>
                  </div>
                </td>
              </tr>
              <tr v-for="{ record_id, audit_date, certification_date_debut, certification_date_fin, certification_state, ...operator } in searchRecords" :key="record_id" class="operator-record fr-enlarge-link">
                <td>
                  <router-link :to="`/exploitations/${operator.numeroBio}`" class="fr-link">
                    {{ operator.nom }}
                  </router-link><br/>
                  <span class="fr-hint-text">{{ operator.commune }}, {{ operator.codePostal }}</span>
                </td>
                <td class="fr-text--align-right">
                  <time :datetime="operator.dateEngagement" v-if="operator.dateEngagement">{{ monthYearDateFormat(operator.dateEngagement) }}</time>
                  <span aria-hidden v-else>-</span>
                </td>
                <td class="fr-text--align-right">
                  <time :datetime="audit_date" v-if="audit_date">{{ monthYearDateFormat(audit_date) }}</time>
                  <span aria-hidden v-else>-</span>
                </td>
                <td class="fr-text--align-right badges">
                  <ParcellaireState :record="{ certification_date_debut, certification_state, audit_date }" :show-date="false" />
                  <span v-if="certification_date_fin" class="fr-hint-text">
                    Du {{ dateFormat(certification_date_debut) }} au {{ dateFormat(certification_date_fin) }}
                  </span>
                  <span aria-hidden class="fr-ml-1w fr-icon-arrow-right-line fr-icon--sm" />
                </td>
              </tr>
            </tbody>
            <tfoot v-if="!isSearching && hasResults">
              <tr>
                <td colspan="3" class="results-total">{{ searchRecords.length }} sur {{ pagination.total }} résultats</td>
                <td>
                  <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline fr-btns-group--pagination results-page-selector">
                    <li class="fr-mr-2v">
                      <div class="fr-select-group fr-select-group--inline">
                        <select class="fr-select" id="search-results-page-selector" name="page" :value="page" @change="$event => updateQuery({ page: $event.target.value })">
                          <option value="" disabled hidden>Sélectionner un numéro de pagination</option>
                          <option :value="page" :key="page" v-for="page in pagination.page_max">{{ page }}</option>
                        </select>
                        <label class="fr-label" for="search-results-page-selector">
                          sur {{ pagination.page_max }} pages
                        </label>
                      </div>
                    </li>
                    <li><button class="fr-btn fr-btn--tertiary-no-outline fr-icon-arrow-left-s-line pagination-page-previous" :disabled="!hasPagination || currentPage === 1" @click="updateQuery({ page: currentPage-1 })">Page précédente</button></li>
                    <li><button class="fr-btn fr-btn--tertiary-no-outline fr-icon-arrow-right-s-line pagination-page-next" :disabled="!hasPagination || currentPage === pagination.page_max" @click="updateQuery({ page: currentPage+1 })">Page suivante</button></li>
                  </ul>
                </td>
              </tr>
            </tfoot>
          </table>

          <p class="fr-mt-3w">
            <span class="fr-icon fr-icon-questionnaire-fill fr-mr-1w" aria-hidden />

            Les noms d'exploitations vous semblent incorrects&nbsp;?
            <a href="https://notification.agencebio.org/" target="_blank">Modifiez-les sur le Portail de Notification</a>
            de l'Agence Bio.
          </p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, ref, watch } from 'vue'
import { storeToRefs } from 'pinia'
import { useRoute, useRouter } from 'vue-router'
import { AxiosError } from 'axios'

import ParcellaireState from '@/components/record/State.vue'
import Spinner from '@/components/Spinner.vue'
import TableSort from '@/components/record/modals/TableSort.vue'
import { monthYearDateFormat, dateFormat } from '@/components/dates.js'

import { searchOperators } from '@/cartobio-api.js'
import { useUserStore } from '@/stores/index.js'

const props = defineProps({
  search: {
    type: String,
    default: ''
  },
  page: {
    type: String,
    default: '1',
    validator: (value) => parseInt(value, 10) > 0
  },
  sort: {
    type: String,
    default: 'audit_date',
    validator: (value) => ['nom', 'engagement_date', 'audit_date', 'statut'].includes(value)
  },
  order: {
    type: String,
    default: 'desc',
    validator: (value) => ['asc', 'desc'].includes(value)
  }
})


const userStore = useUserStore()
const router = useRouter()
const route = useRoute()

const { startPage, user } = storeToRefs(userStore)

const error = ref('')
const isSearching = ref(false)
const searchRecords = ref([])

// controlled by the form
const userInput = ref(props.search)
const searchInput = computed(() => props.search ?? '')
const currentPage = computed(() => parseInt(props.page, 10))
const sortOrder = ref({
  sort: props.sort,
  order: props.order
})

const pagination = ref({
  total: 0,
  page: props.page,
  page_max: 1
})

const showOptionalControl = computed(() => Boolean(searchInput.value))
const hasResults = computed(() => searchRecords.value.length > 0)
const hasPagination = computed(() => searchRecords.value.length && searchRecords.value.length < pagination.value.total)

const sortAttribute = (sort) => {
  if (sort !== sortOrder.value.sort) {
    return null
  }

  return sortOrder.value.order === 'asc' ? 'ascending' : 'descending'
}

function updateQuery (query) {
  router.replace({
    path: startPage.value,
    query: {
      ...route.query,
      ...Object.entries(query)
        .filter(([, value]) => value !== undefined)
        .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {}),
    },
  })
}

/**
 * @param {Error} error
 * @return {Boolean}
 */
function isNetworkError (error) {
  return error.name === "AxiosError" &&
    [
      AxiosError.ETIMEDOUT,
      AxiosError.ECONNABORTED,
      AxiosError.ERR_NETWORK
    ].includes(error.code)
}

async function doSearch (input, page, sort, order) {
  error.value = ''
  isSearching.value = true
  searchRecords.value = []

  try {
    const results = await searchOperators({ input: input.trim(), page, sort, order })

    pagination.value = results.pagination
    searchRecords.value = results.records
  }
  catch (e) {
    pagination.value = {
      total: 0,
      page: props.page,
      page_max: 1
    }

    if (isNetworkError(e)) {
      error.value = 'Une erreur de réseau est survenue. Vérifiez votre connexion internet.'
    }
    else {
      throw e
    }
  }
  finally {
    isSearching.value = false
  }
}

watch([searchInput, currentPage, sortOrder], () =>  doSearch(searchInput.value, currentPage.value, sortOrder.value.sort, sortOrder.value.order), { immediate: true })
watch(() => route.query.sort, (v) => sortOrder.value.sort = v ?? 'audit_date')
watch(() => route.query.order, (v) => sortOrder.value.order = v ?? 'desc')
watch(() => route.query.search, (search) => {
  userInput.value = (search || '').trim()

  if (!searchInput.value && ['nom', 'engagement_date'].includes(sortOrder.value.sort)) {
    sortOrder.value = { sort: 'audit_date', order: 'desc' }
  }
}, { immediate: true })
</script>

<style scoped>
.center {
  text-align: center;
}

.fr-btns-group--pagination {
  .fr-label, .fr-select {
    font-size: inherit;   /* reset size so as they are consistent */
  }

  .fr-btn {
    margin: 0;
  }
}

.fr-select-group--inline {
  display: flex;
  align-items: center;

  select {
    background-color: transparent;
    box-shadow: none;
    text-align: right;
    width: 6rem;  /* up to 3 digits, so 999 pages */
  }
}

.fr-table table {
  display: table;
  margin-bottom: 1.5rem;

  thead th {
    white-space: nowrap;
  }

  tfoot {
    background-color: var(--background-alt-grey);
    background-size: 100% 1px;
    background-repeat: no-repeat;
    background-position: top;
    background-image: linear-gradient(0deg, #3a3a3a, #3a3a3a);
  }
}

.fr-enlarge-link:hover {
  background-color: var(--background-alt-blue-france-hover) !important;
}
.fr-enlarge-link:active {
  background-color: var(--light-background-action-low-blue-france) !important;
}

.results-title {
  font-style: italic;
  color: var(--text-mention-grey);
  line-height: 1.5rem;
  margin-bottom: 0.5rem;
}

.fr-link {
  font-weight: bold;
}
.fr-text--align-right {
  text-align: right !important;
}
.badges span {
  vertical-align: middle;
}

[aria-disabled="true"] {
  opacity: .5;
  pointer-events: none;
  cursor: wait;
}

.fr-alert--waiting::before {
  mask-image: url(@gouvfr/dsfr/icons/system/time-fill.svg);
}
</style>
