<route lang="yaml">
meta:
  requiresAuth: true
  requiredRoles: ['oc']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">Exploitations {{ currentCertificate.organisme }}</h1>

        <form class="fr-search-bar fr-search-bar--lg" id="header-search" role="search">
          <label class="fr-label" for="search-input">
              Recherche
          </label>
          <input class="fr-input" placeholder="Nom de l'exploitation recherchée…" v-model="operatorName" required autofocustype="search" id="search-input">
          <button class="fr-btn" title="Rechercher" :disabled="isLoading">
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12">
        <div :aria-disabled="isSearching" class="fr-table fr-table--bordered fr-table--no-caption">
          <table>
            <caption>Liste des exploitations</caption>
            <colgroup>
              <col width="50%" />
              <col width="20%" />
              <col width="30%" />
            </colgroup>
            <thead>
              <th scope="col">Exploitation</th>
              <th scope="col" class="fr-text--align-right">Date d'engagement</th>
              <th scope="col" class="fr-text--align-right">Actions</th>
            </thead>
            <tbody>
              <tr v-for="({ item, score }) in filteredOperators" :key="item.id" :data-score="score">
                <th>{{ item.nom }}</th>
                <td class="fr-text--align-right">{{ item.dateEngagement }}</td>
                <td class="fr-text--align-right">
                  <router-link :to="`/certification/exploitations/${item.id}`" class="fr-link fr-fi-arrow-right-line fr-link--icon-right">Commencer un audit</router-link>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, toRefs, ref, watchEffect } from 'vue'
import Fuse from 'fuse.js'
import debounce from 'lodash/debounce'

import store from '@/store.js'
import { getOperators } from '@/cartobio-api.js'

const { currentUser } = toRefs(store.state)
const operatorName = ref('')
const isLoading = ref(false)
const isSearching = ref(false)
const { operators } = await getOperators()
const filteredOperators = ref([])
const fuse = new Fuse(operators, {
  includeScore: true,
  threshold: 0.8,
  // https://fusejs.io/api/options.html#distance
  distance: 100,
  minMatchCharLength: 3,
  keys: [
    'nom'
  ]
})

const currentCertificate = computed(() => currentUser.value.certificats.at(-1))
const search = debounce((textInput) => {
  console.log('debounce', textInput)
  filteredOperators.value = fuse.search(textInput).slice(0, 50)
}, 500)

watchEffect(() => search(operatorName.value.trim()))
</script>

<style>
.fr-table table {
  display: table;
}
.fr-text--align-right {
  text-align: right !important;
}

[aria-disabled="true"] {
  opacity: .5;
  pointer-events: none;
  cursor: wait;
}
</style>
