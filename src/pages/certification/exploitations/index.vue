<route lang="yaml">
meta:
  requiredRoles: ['certif', 'audit']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">
          Exploitations {{ user.organismeCertificateur.nom }}
        </h1>

        <form
          @submit.prevent="updateQuery"
          class="fr-search-bar fr-search-bar--lg"
          id="header-search"
          role="search"
        >
          <label
            class="fr-label"
            for="search-input"
          >
            Recherche
          </label>
          <input
            class="fr-input"
            placeholder="Chercher une exploitation ou un agriculteur…"
            minlength="3"
            autocomplete="cartobio-operator"
            v-model="operatorName"
            required
            autofocustype="search"
            id="search-input"
          >
          <button
            class="fr-btn"
            title="Rechercher"
            :disabled="isSearching"
          >
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12">
        <div
          v-if="operators.length && !isSearching"
          class="fr-table fr-table--bordered"
        >
          <h2
            class="fr-text--mention fr-text--md fr-text--regular results-title"
            v-if="!route.query.search"
          >
            Dernières exploitations modifiées
          </h2>
          <table>
            <colgroup>
              <col width="50%">
              <col width="15%">
              <col width="35%">
            </colgroup>
            <thead>
              <th scope="col">
                Exploitation
              </th>
              <th
                scope="col"
                class="fr-text--align-right"
              >
                Date d'engagement
              </th>
              <th
                scope="col"
                class="fr-text--align-right"
              >
                Statut
              </th>
            </thead>
            <tbody>
              <tr
                v-for="item in operators"
                :key="item.id"
                class="clickable"
                @click.stop="$router.push(`/certification/exploitations/${item.id}`)"
              >
                <th>{{ item.nom }}</th>
                <td class="fr-text--align-right">
                  {{ monthYearDateFormat(item.dateEngagement) }}
                </td>
                <td class="fr-text--align-right">
                  <router-link
                    :to="`/certification/exploitations/${item.id}`"
                    class="fr-link fr-link--no-underline fr-fi-arrow-right-line fr-link--icon-right"
                  >
                    <ParcellaireState
                      :state="item.certification_state"
                      :date="item.created_at"
                    />
                  </router-link>
                </td>
              </tr>
            </tbody>
          </table>

          <router-link
            v-if="route.query.search"
            to="/certification/exploitations"
            class="fr-link fr-icon-arrow-left-fill fr-link--icon-left"
          >
            Revenir aux exploitations
          </router-link>

          <p class="fr-mt-3w">
            <span
              class="fr-icon fr-icon-questionnaire-fill fr-mr-1w"
              aria-hidden
            />

            Les noms d'exploitations vous semblent incorrects&nbsp;?
            <a
              href="https://notification.agencebio.org/"
              target="_blank"
            >Modifiez-les sur le Portail de Notification</a>
            de l'Agence Bio.
          </p>
        </div>

        <div
          class="fr-alert fr-alert--info fr-alert--waiting"
          v-else-if="isSearching"
          role="alert"
        >
          <p><em>Recherche en cours</em></p>
        </div>

        <div
          class="fr-alert fr-alert--warning"
          v-else-if="route.query.search && operators.length === 0"
          role="alert"
        >
          <h3 class="fr-alert__title">
            Aucune exploitation trouvée
          </h3>
          <p>Est-ce qu'elle est déclarée sous ce nom sur le portail de notification de l'Agence Bio ?</p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, watch, ref, readonly } from 'vue'
import { storeToRefs } from 'pinia'
import { useRoute, useRouter } from 'vue-router'

import ParcellaireState from '@/components/Certification/State.vue'
import { monthYearDateFormat } from '@/components/dates.js'

import { searchOperators as search, fetchLatestOperators } from '@/cartobio-api.js'
import { useUserStore } from '@/stores/index.js'

const userStore = useUserStore()
const router = useRouter()
const route = useRoute()

const { user } = storeToRefs(userStore)

const operatorName = ref()
const isSearching = ref(false)
const defaultOperators = readonly(await fetchLatestOperators())
const searchOperators = ref([])

const operators = computed(() => route.query.search ? searchOperators.value : defaultOperators)

watch(() => route.query.search, (name, previousName) => {
  operatorName.value = name

  if (!name) {
    searchOperators.value = []
    isSearching.value = false
    return
  }

  if (name !== previousName) {
    doSearch()
  }
}, { immediate: true })

function updateQuery () {
  router.push({
    path: '/certification/exploitations',
    query: { search: operatorName.value },
  })
}

async function doSearch () {
  isSearching.value = true
  const { operators: results } = await search(operatorName.value.trim())

  searchOperators.value = results
  isSearching.value = false
}
</script>

<style>
.fr-table table {
  display: table;
  margin-bottom: 1.5rem;
}

.results-title {
  font-style: italic;
  color: var(--text-mention-grey);
  line-height: 1.5rem;
  margin-bottom: 0.5rem;
}

.fr-link--no-underline {
  background-image: none;
}
.fr-text--align-right {
  text-align: right !important;
}

[aria-disabled="true"] {
  opacity: .5;
  pointer-events: none;
  cursor: wait;
}

.fr-alert--waiting::before {
  mask-image: url(@gouvfr/dsfr/icons/system/time-fill.svg);
}
</style>
