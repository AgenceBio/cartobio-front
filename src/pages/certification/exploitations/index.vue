<route lang="yaml">
meta:
  requiresAuth: true
  requiredRoles: ['oc']
  seo:
    title: Liste des exploitations
</route>

<template>
  <section class="fr-container fr-py-6w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12">
        <h1 class="fr-h6">Exploitations {{ currentCertificate.organisme }}</h1>

        <form @submit.prevent="doSearch" class="fr-search-bar fr-search-bar--lg" id="header-search" role="search">
          <label class="fr-label" for="search-input">
            Recherche
          </label>
          <input class="fr-input" placeholder="Chercher une exploitation ou un agriculteur…" minlength="3" autocomplete="cartobio-operator" v-model="operatorName" required autofocustype="search" id="search-input">
          <button class="fr-btn" title="Rechercher" :disabled="isSearching">
            Rechercher
          </button>
        </form>
      </div>

      <div class="fr-col-12">
        <div :aria-disabled="isSearching" class="fr-table fr-table--bordered" v-if="operators.length">
          <table>
            <caption v-if="searchCount === 0">Dernières exploitations modifiées</caption>
            <caption v-else>Résultats de la recherche</caption>
            <colgroup>
              <col width="50%" />
              <col width="15%" />
              <col width="35%" />
            </colgroup>
            <thead>
              <th scope="col">Exploitation</th>
              <th scope="col" class="fr-text--align-right">Date d'engagement</th>
              <th scope="col" class="fr-text--align-right">Actions</th>
            </thead>
            <tbody>
              <tr v-for="item in operators" :key="item.id">
                <th>{{ item.nom }}</th>
                <td class="fr-text--align-right">{{ monthYearDateFormat(item.dateEngagement) }}</td>
                <td class="fr-text--align-right">
                  <router-link :to="`/certification/exploitations/${item.id}`" class="fr-link fr-link--no-underline fr-fi-arrow-right-line fr-link--icon-right">
                    <ParcellaireState :record="item" />
                  </router-link>
                </td>
              </tr>
            </tbody>
          </table>

          <p class="fr-mt-3w">
            <span class="fr-icon fr-icon-questionnaire-fill fr-mr-1w" aria-hidden />

            Les noms d'exploitations vous semblent incorrects&nbsp;?
            <a href="https://notification.agencebio.org/" target="_blank">Modifiez-les sur le Portail de Notification</a>
            de l'Agence Bio.
          </p>
        </div>
        <div class="fr-alert fr-alert--warning" v-else-if="searchCount && operators.length === 0">
          <h3 class="fr-alert__title">Aucune exploitation trouvée</h3>
          <p>Est-ce qu'elle est déclarée sous ce nom sur le portail de notification de l'Agence Bio ?</p>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, toRefs, ref, readonly } from 'vue'
import ParcellaireState from '@/components/Certification/State.vue'

import store from '@/store.js'
import { searchOperators as search, fetchLatestOperators } from '@/cartobio-api.js'
import { monthYearDateFormat } from '@/components/dates.js'

const { currentUser } = toRefs(store.state)
const operatorName = ref('')

const isSearching = ref(false)
const searchCount = ref(0)
const defaultOperators = readonly(await fetchLatestOperators())
const searchOperators = ref([])

const currentCertificate = computed(() => currentUser.value.certificats.at(-1))
const operators = computed(() => searchCount.value ? searchOperators.value : defaultOperators)

async function doSearch () {
  isSearching.value = true
  const { operators: results } = await search(operatorName.value.trim())

  searchOperators.value = results
  isSearching.value = false
  searchCount.value = searchCount.value + 1
}
</script>

<style>
.fr-table table {
  display: table;
}
.fr-link--no-underline {
  background-image: none;
}
.fr-text--align-right {
  text-align: right !important;
}

[aria-disabled="true"] {
  opacity: .5;
  pointer-events: none;
  cursor: wait;
}
</style>
