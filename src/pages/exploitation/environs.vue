<route lang="yaml">
meta:
  requiresAuth: true
  requiresGeodata: true
  seo:
    title: Parcelles environnantes
</route>

<template>
  <div class="fr-container--fluid">
    <div class="fr-row">
      <div class="fr-col-lg-12">
        <MapContainer class="map" @load="loadSourceAndLayers" @zoom:change="zoomLevel = $event" :style="mapStyles" :bounds="mapBounds">
          <GeojsonLayer :data="parcellaire" name="parcellaire-operateur" before="parcelles" />

          <template #legend>
            <MapLegend class="map-legend">
              <h3 class="fr-text--lg fr-mb-0">Légende</h3>
              <ul class="fr-list fr-my-1w">
                <li class="fr-badge fr-badge--mes-parcelles">Mes parcelles</li>
                <li class="fr-badge fr-badge--risque">Conv. à risque</li>
                <li class="fr-badge fr-badge--conventionnelle">Conventionnelle</li>
                <li class="fr-badge fr-badge--sans-culture">Sans culture</li>
                <li class="fr-badge fr-badge--bio">En bio</li>
              </ul>
              <p>
                <button class="fr-btn fr-btn--sm fr-btn--tertiary fr-btn--icon-left fr-icon-compass-3-line" @click="focusOnOriginalBbox">
                  Centrer sur votre exploitation
                </button>
              </p>
            </MapLegend>
          </template>
        </MapContainer>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, ref, toRefs, unref, shallowRef, watch, nextTick, reactive, toRaw } from 'vue'
import bbox from '@turf/bbox'
import { all as mergeAll } from 'deepmerge'

import baseStyle from '@/map-styles/base.json'
import cadastreStyle from '@/map-styles/cadastre.json'
import surroundingsStyle from '@/map-styles/surroundings.json'

import store from '@/store.js'
import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import MapLegend from '@/components/Map/Legend.vue'

const { parcellaire } = toRefs(store.state)

const hoveredFeatureId = ref(null)
const zoomLevel = ref(null)

const map = shallowRef(null)
const mapBounds = bbox(unref(parcellaire))


const mapStyles = computed(() => {
  return mergeAll([
    baseStyle,
    surroundingsStyle,
    cadastreStyle,
  ])
})

const getFeatureById = (id) => {
  return parcellaire.value.features.find(feature => feature.id === id)
}

function focusOnOriginalBbox () {
  zoomInto(parcellaire.value, { maxZoom: 12 })
}

function zoomInto (featureOrFeatureCollection, { maxZoom }) {
  const bounds = bbox(featureOrFeatureCollection)
  const { center, zoom, bearing } = map.value.cameraForBounds(bounds, { padding: 50, maxZoom }) ?? {}
  if (center && zoom) {
    map.value.flyTo({ center, zoom, bearing })
  }
}

function loadSourceAndLayers (maplibreMap) {
  map.value = maplibreMap

  // zoomInto(parcellaire.value, { maxZoom: 13 })

  watch(hoveredFeatureId, (id, previousId) => {
    if (id) {
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id }, { hover: true })
    }

    if (previousId){
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id: previousId }, { hover: false })
    }
  })

  maplibreMap.on('mousemove', 'parcellaire-operateur-geometry', ({ features }) => {
    if (features.length) {
      hoveredFeatureId.value = features[0].id
      map.value.getCanvas().style.cursor = "pointer"
    }
  })

  maplibreMap.on('mouseleave', 'parcellaire-operateur-geometry', () => {
    if (hoveredFeatureId.value) {
      hoveredFeatureId.value = null
      maplibreMap.getCanvas().style.cursor = ""
    }
  })
}
</script>

<style scoped>
.map {
  background: #ccc;
  height: 60vh;
  position: relative;
}

.fr-card--sm {
  height: auto;
}
.fr-card--sm .fr-label {
  font-size: .9em;
}

.fr-card .fr-badge {
  margin-right: .5em;
  margin-bottom: .5em;
}

.fr-badge--mes-parcelles {
  color: #fff;
  background-color: var(--blue-france-sun-113-625);
}
.fr-badge--risque {
  color: #fff;
  background-color: var(--red-marianne-425-625);
}
.fr-badge--conventionnelle {
  /* color: var(--); */
  background-color: var(--red-marianne-850-200);
}
.fr-badge--sans-culture {
  color: #fff;
  background-color: var(--green-tilleul-verveine-main-707);
}
.fr-badge--bio {
  color: #fff;
  background-color: var(--success-425-625);
}
</style>
