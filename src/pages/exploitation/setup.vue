<route lang="yaml">
classNames: fr-container fr-my-5w
meta:
  requiresAuth: true
  seo:
    title: Importer mon parcellaire existant
</route>

<template>
  <div class="fr-container fr-my-5w">
    <div class="fr-stepper">
      <h2 class="fr-stepper__title">
        <span class="fr-stepper__state">Étape {{ currentStep.index }} sur {{ allSteps.length }}</span>
        {{ currentStep.title }}
      </h2>
      <div
        class="fr-stepper__steps"
        :data-fr-current-step="currentStep.index"
        :data-fr-steps="allSteps.length"
      />
      <p
        class="fr-stepper__details"
        v-if="nextStep"
      >
        <span class="fr-text--bold">Étape suivante&nbsp;:</span> {{ nextStep.title }}
      </p>
    </div>

    <section v-if="currentStep.index === 1">
      <p class="fr-text--lg">
        Nous vous demandons quelques informations lors
        d'une <em>première utilisation</em> de CartoBio.
      </p>

      <p class="fr-text--lg">
        Nous avons pensé le procédé pour qu'il vous évite du travail de recopie
        lors du prochain audit avec votre organisme de certification.
      </p>

      <p>
        <button
          @click="currentStepIndex = currentStepIndex + 1"
          class="fr-btn"
        >
          {{
            nextStep.title }}
        </button>
      </p>
    </section>
    <section v-else-if="currentStep.index === 2 || currentStep.index === 3">
      <OperatorSetup
        @source:change="onSourceChange"
        @import:start="onUploadStart"
        @import:preview="onUploadPreview"
        @import:complete="onSuccess"
        @import:error="onError"
      />
    </section>

    <section v-else-if="currentStep.index === 4">
      <p>
        Félicitations, votre parcellaire a été créé sur CartoBio.<br>
        Votre organisme de certification y aura accès pour votre audit.
      </p>

      <router-link
        to="/exploitation/parcellaire"
        class="fr-btn"
      >
        Accéder à mon parcellaire
      </router-link>
    </section>
  </div>
</template>

<script setup>
import { computed, readonly, ref } from 'vue'
import { statsPush } from '@/stats.js'

import OperatorSetup from '@/components/OperatorSetup/index.vue'

const importTool = ref('')

const currentStepIndex = ref(0)
const allSteps = readonly([
  { title: 'Bienvenue sur CartoBio' },
  { title: 'Choix des données géographiques' },
  { title: 'Prévisualisation' },
  { title: 'Accéder au parcellaire' },
])

const currentStep = computed(() => ({ index: currentStepIndex.value + 1, ...allSteps[currentStepIndex.value] }))
const nextStep = computed(() => currentStepIndex.value + 1 < allSteps.length ? allSteps[currentStepIndex.value + 1] : null)

function onSourceChange (source) {
  importTool.value = source
  statsPush(['trackEvent', 'setup', 'sourceSelect', importTool.value])
}

function onUploadStart () {
  statsPush(['trackEvent', 'setup', `import:${importTool.value}`, 'start'])
  currentStepIndex.value = 1
}

function onUploadPreview () {
  currentStepIndex.value += 1
}

function onSuccess () {
  statsPush(['trackEvent', 'setup', `import:${importTool.value}`, 'ok'])
  currentStepIndex.value += 1
}

function onError () {
  statsPush(['trackEvent', 'setup', `import:${importTool.value}`, 'error'])
}
</script>

<style scoped>
[aria-current="true"] {
  font-weight: bold;
}

.fr-text--lg {
  max-width: 40rem;
}

.sources {
  display: flex;
  gap: 1rem;
  list-style: none;
  padding: 0;
}

article .screenshot {
  max-width: min(500px, 50vw);
}

details.help summary {
  display: block;
}
</style>
