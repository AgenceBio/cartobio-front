<route lang="yaml">
meta:
  requiresAuth: true
  requiresGeodata: true
  seo:
    title: Gestion de mon parcellaire AB
</route>

<template>
  <section class="fr-container fr-py-2w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <OperatorSummary :operator="currentUser" :record="record" />
        <FeaturesTable :features="parcellaire" :operator="currentUser" :edit-form="EditForm" :validation-rules="validationRules" />
      </div>

      <div class="fr-col-6">
        <MapContainer :style="baseStyle" :options="{ interactive: false }" class="map" @load="setupWatchers" :bounds="mapBounds">
          <GeojsonLayer :data="parcellaire" name="parcellaire-operateur" />
        </MapContainer>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, readonly, toRefs } from 'vue'
import bbox from '@turf/bbox'

import FeaturesTable from '@/components/Features/Table.vue'
import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import baseStyle from '@/map-styles/base.json'
import EditForm from '@/components/Features/SingleItemOperatorForm.vue'
import OperatorSummary from '@/components/Operator/Summary.vue'

import store from '@/store.js'
import { useFeaturesStore } from '@/stores/features.js'
import { OPERATOR_RULES } from '@/referentiels/ab.js'

const validationRules = readonly({
  rules: OPERATOR_RULES,
  success: 'fr-icon--neutral',
  error: 'fr-icon--warning'
})

const { currentUser, parcellaire, record } = toRefs(store.state)

const mapBounds = computed(() => bbox(parcellaire.value))

const featureStore = useFeaturesStore()
featureStore.setAll(readonly(parcellaire.value.features))

function setupWatchers (map) {
  featureStore.bindMaplibreFeatureState({ map, source: 'parcellaire-operateur' })
  featureStore.bindMaplibreInteractions({ map, layer: 'parcellaire-operateur-geometry' })
}
</script>

<style>
.single-checkbox input[type="checkbox"] + label::before {
  left: auto !important;
  top: auto !important;
  margin: 0 !important;
}
.single-checkbox input[type="checkbox"] + label {
  margin: 0 !important;
}
</style>

<style scoped>
.fr-form-group[disabled="true"] {
  opacity: 0.5;
  pointer-events: none;
  cursor: default;
}
.fr-table {
  border-collapse: collapse;
  width: 100%;
}

.fr-table .tools {
  padding-left: 0;
  padding-right: 0;
}

  table .color-badge {
    background-color: var(--accent-color);
    display: inline-block;
    height: 14px;
    width: 14px;
  }

.rowIdCell small {
  font-weight: normal;
  margin-left: .5rem;
}

.fr-table td.numeric,
.fr-table th.numeric {
  font-variant-numeric: tabular-nums;
  text-align: right !important;
}

.culture-type,
.culture-group {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
  max-width: 350px;
}

.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: sticky;
  top: 0;
  width: 100%;
}

</style>
