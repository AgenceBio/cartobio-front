<route lang="yaml">
meta:
  requiresAuth: true
  requiresGeodata: true
  seo:
    title: Gestion de mon parcellaire AB
</route>

<template>
  <section class="fr-container fr-py-2w">
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <div class="fr-select-group fr-my-3w">
          <label class="fr-label" for="plots-group-by">
            Grouper les parcelles par
          </label>
          <select class="fr-select" id="plots-group-by" v-model="userGroupingChoice">
            <option :value="key" v-for="({ label }, key) in groupingChoices" :key="key">
              {{ label }}
            </option>
          </select>
        </div>

        <table class="fr-table fr-table--bordered fr-pt-0" @mouseout="hoveredFeatureId = null">
          <caption>
            Votre parcellaire
          </caption>
          <colgroup>
            <col width="5%" />
            <col width="50%" />
            <col width="30%" />
            <col width="5%" />
            <col width="10%" />
          </colgroup>
          <thead>
            <tr>
              <th scope="col">
                <div class="fr-checkbox-group single-checkbox">
                  <input type="checkbox" id="select-all" :checked="allSelected" @click="toggleAllSelected" />
                  <label class="fr-label" for="select-all" />
                </div>
              </th>
              <th colspan="3" class="numeric">
                {{ parcellaire.features.length }} parcelles
              </th>
              <th scope="col" class="numeric">
                {{ inHa(surface(parcellaire)) }}&nbsp;ha
              </th>
            </tr>
          </thead>
          <FeatureGroup v-for="featureGroup in featureGroups" :featureGroup="featureGroup" :key="featureGroup.key" v-model:hoveredId="hoveredFeatureId" v-model:selectedIds="selectedFeatureIds" />
        </table>

        <aside>
          <FeatureActions :parcellaire="parcellaire" :selectedFeatureIds="selectedFeatureIds" />
        </aside>

        <p>
          <a href="#top" class="fr-icon--sm fr-icon-arrow-up-fill">
            retour en haut de page
          </a>
        </p>
      </div>

      <div class="fr-col-6">
        <MapContainer :style="baseVectorStyles" :options="{ interactive: false }" class="map" @load="loadSourceAndLayers" :bounds="mapBounds">
          <GeojsonLayer :data="parcellaire" name="parcellaire-operateur" />
        </MapContainer>
      </div>
    </div>

    <div class="grid-row">
      <div class="fr-col-12">
        <AbDetails class="fr-my-3w" :user="currentUser" />
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, ref, toRefs, shallowRef, watch } from 'vue'
import bbox from '@turf/bbox'
import centroid from '@turf/centroid'

import { surface, inHa, getFeatureGroupsStyles, getFeatureGroups, groupingChoices } from './features.js'

import store from '@/store.js'
import FeatureGroup from '@/components/Features/FeatureGroup.vue'
import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import AbDetails from '@/components/Certification/AbDetails.vue'
import FeatureActions from '@/components/Certification/FeatureActions.vue'

const { currentUser, parcellaire } = toRefs(store.state)

const userGroupingChoice = ref('CULTURE')
const handleUserGroupingChoice = ($event) => userGroupingChoice.value = $event.target.value

// hovered feature
const hoveredFeatureId = ref(null)
const baseVectorStyles = 'https://openmaptiles.geo.data.gouv.fr/styles/osm-bright/style.json'

// user single selected/feature focus
const selectedFeatureId = ref(null)
const selectedFeature = computed(() => selectedFeatureId.value ? getFeatureById(selectedFeatureId.value) : null)

// user selected/checked features
const selectedFeatureIds = ref([])
const selectedFeatures = computed(() => selectedFeatureIds.value.map(getFeatureById))

const map = shallowRef(null)
const mapBounds = computed(() => bbox(parcellaire.value))
const popupLngLat = ref([0, 0])

// make it computed, compared between selected items and all items
const allSelected = ref(false)

function toggleAllSelected () {
  if (allSelected.value) {
    selectedFeatureIds.value = []
  }
  else {
    selectedFeatureIds.value = parcellaire.value.features.map(({ id }) => id)
  }

  allSelected.value = !allSelected.value
}

function toggleSingleSelected (featureId) {
  // we remove it if it was available
  if (selectedFeatureIds.value.includes(featureId)) {
    selectedFeatureIds.value = selectedFeatureIds.value.filter(id => id !== featureId)
    allSelected.value = false
  }
  // otherwise, we add it to the select list
  else {
    selectedFeatureIds.value = selectedFeatureIds.value.concat([featureId])
  }
}


const featureGroups = computed(() => getFeatureGroups(store.state.parcellaire, userGroupingChoice.value))
const featureGroupsStyles = computed(() => getFeatureGroupsStyles(featureGroups.value))

const getFeatureById = (id) => {
  return parcellaire.value.features.find(feature => feature.id === id)
}

const handleFeatureSelectionFromTable = (id) => {
  if (selectedFeatureId.value === id) {
    selectedFeatureId.value = null
    return
  }

  selectedFeatureId.value = id
  zoomInto(getFeatureById(id), { maxZoom: 15 })
}

function zoomInto (featureOrFeatureCollection, { maxZoom }) {
  const bounds = bbox(featureOrFeatureCollection)
  const { center, zoom, bearing } = map.value.cameraForBounds(bounds, { padding: 50, maxZoom }) ?? {}
  if (center && zoom) {
    map.value.flyTo({ center, zoom, bearing })
  }
}

function loadSourceAndLayers (maplibreMap) {
  map.value = maplibreMap

  // zoomInto(parcellaire.value, { maxZoom: 13 })

  watch(hoveredFeatureId, (id, previousId) => {
    if (id) {
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id }, { hover: true })
    }

    if (previousId){
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id: previousId }, { hover: false })
    }
  })

  watch(() => selectedFeatureIds, (currentIds) => {
    currentIds.value.forEach(id => {
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id }, { selected: true })
    })

    parcellaire.value.features.forEach(({ id }) => {
      const { selected } = maplibreMap.getFeatureState({ id, source: 'parcellaire-operateur' })
      if (selected && !currentIds.value.includes(id)) {
        maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id }, { selected: false })
      }
    })
  }, { deep: true })

  watch(selectedFeatureId, (id, previousId) => {
    if (id) {
      maplibreMap.setFeatureState({ source: 'parcellaire-operateur', id }, { selected: true })

      popupLngLat.value = centroid(selectedFeature.value).geometry.coordinates
    }

    if (previousId){
      map.value.setFeatureState({ source: 'parcellaire-operateur', id: previousId }, { selected: false })
    }
  })

  maplibreMap.on('mousemove', 'parcellaire-operateur-geometry', ({ features }) => {
    if (features.length) {
      hoveredFeatureId.value = features[0].id
      map.value.getCanvas().style.cursor = "pointer"
    }
  })

  maplibreMap.on('mouseleave', 'parcellaire-operateur-geometry', () => {
    if (hoveredFeatureId.value) {
      hoveredFeatureId.value = null
      maplibreMap.getCanvas().style.cursor = ""
    }
  })

  maplibreMap.on('click', 'parcellaire-operateur-geometry', ({ lngLat }) => {
    const point = maplibreMap.project(lngLat)
    const features = maplibreMap.queryRenderedFeatures(point, { layers: ['parcellaire-operateur-geometry'] })

    if (features.length) {
      toggleSingleSelected(features[0].id)
    }
  })
}
</script>

<style>
.single-checkbox input[type="checkbox"] + label::before {
  left: auto !important;
  top: auto !important;
  margin: 0 !important;
}
.single-checkbox input[type="checkbox"] + label {
  margin: 0 !important;
}
</style>

<style scoped>
.fr-form-group[disabled="true"] {
  opacity: 0.5;
  pointer-events: none;
  cursor: default;
}
.fr-table {
  border-collapse: collapse;
  width: 100%;
}

.fr-table .tools {
  padding-left: 0;
  padding-right: 0;
}

  table .color-badge {
    background-color: var(--accent-color);
    display: inline-block;
    height: 14px;
    width: 14px;
  }

.rowIdCell small {
  font-weight: normal;
  margin-left: .5rem;
}

.fr-table td.numeric,
.fr-table th.numeric {
  font-variant-numeric: tabular-nums;
  text-align: right !important;
}

.culture-type,
.culture-group {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
  max-width: 350px;
}

.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: sticky;
  top: 0;
  width: 100%;
}

</style>
