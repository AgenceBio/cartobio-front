<route lang="yaml">
meta:
  requiresAuth: true
  seo:
    title: Gestion de mon parcellaire AB
</route>

<template>
  <OperatorSetup v-if="!recordStore.isSetup" @submit="handleSetup" />
  <section class="fr-container fr-py-2w" v-else>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-6">
        <OperatorSummary :operator="record.operator" :record="record" />
        <div class="fr-alert fr-alert--warning fr-mb-3w" v-if="hasFailures">
          <ValidationErrors :validation-result="validationResult" />
        </div>
        <FeaturesTable :features="featureStore.collection" :operator="record.operator" :edit-form="EditForm" :validation-rules="validationRules" :mass-actions="massActions" />
      </div>

      <div class="fr-col-6 fr-col--map">
        <div class="sticky-map" :class="{ 'sticky-map--full-size': isMapFullSize }">
          <div :class="{ 'full-size-map fr-card fr-card--shadow fr-p-2w': isMapFullSize }">
            <MapContainer class="map" :class="{ 'map--full-size': isMapFullSize }" :mode="isMapFullSize ? 'fullsize' : 'compact'" @load="setupWatchers" :bounds="mapBounds">
              <GeojsonLayer :style="baseStyle" name="base" />
              <GeojsonLayer v-if="showSurroundings" :style="cadastreStyle" name="cadastre" />
              <GeojsonLayer v-if="showSurroundings" :style="surroundingsStyle" name="surroundings" />
              <GeojsonLayer :data="featureStore.collection" name="parcellaire-operateur" />
              <template #legend>
                <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm fr-m-3w full-size-button" @click="isMapFullSize = !isMapFullSize">
                    <span v-if="!isMapFullSize" class="fr-fi-arrow-left-s-line-double fr-fi--sm fr-mr-1w"></span>
                    {{ isMapFullSize ? "RÃ©duire la carte" : "Agrandir la carte" }}
                    <span v-if="isMapFullSize" class="fr-fi-arrow-right-s-line-double fr-fi--sm fr-ml-1w"></span>
                </button>
                <button class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm fr-m-3w fr-btn--icon-left fr-icon-compass-3-line center-button" @click="focusOnOriginalBbox">
                  Centrer sur votre exploitation
                </button>
                <SurroundingsLegend v-if="showSurroundings" />
              </template>
            </MapContainer>
            <div class="fr-toggle">
              <input type="checkbox" v-model="showSurroundings" class="fr-toggle__input" id="toggle-surroundings">
              <label class="fr-toggle__label" for="toggle-surroundings">Parcelles environnantes</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import { computed, markRaw, readonly, ref, shallowRef } from 'vue'
import { storeToRefs } from 'pinia'
import bbox from '@turf/bbox'

import FeaturesTable from '@/components/Features/Table.vue'
import MapContainer from '@/components/Map/MapContainer.vue'
import GeojsonLayer from '@/components/Map/GeojsonLayer.vue'
import baseStyle from '@/map-styles/base.json'
import EditForm from '@/components/Features/SingleItemOperatorForm.vue'
import OperatorSummary from '@/components/Operator/Summary.vue'
import OperatorSetup from '@/components/Operator/Setup.vue'
import CultureTypeModal from '@/components/Operator/CultureTypeModal.vue'

import { useFeaturesStore, usePermissions, useRecordStore } from "@/stores/index.js"
import { applyValidationRules, OPERATOR_RULES } from '@/referentiels/ab.js'
import surroundingsStyle from "@/map-styles/surroundings.json";
import cadastreStyle from "@/map-styles/cadastre.json";
import SurroundingsLegend from "@/components/Map/SurroundingsLegend.vue";
import ValidationErrors from "@/components/Features/ValidationErrors.vue"

const validationRules = readonly({
  rules: OPERATOR_RULES,
})
const validationResult = computed(() => applyValidationRules(OPERATOR_RULES, ...featureStore.collection.features))
const hasFailures = computed(() => Boolean(validationResult.value.failures))

const permissions = usePermissions()

const massActions = permissions.canChangeCulture ? [
  { label: 'Modifier les cultures', component: markRaw(CultureTypeModal) },
] : []

const recordStore = useRecordStore()
const featureStore = useFeaturesStore()
const { record } = storeToRefs(recordStore)

const showSurroundings = ref(false)

const isMapFullSize = ref(false)

const mapRef = shallowRef(null)

const mapBounds = computed(() => recordStore.isSetup ? bbox(featureStore.collection) : [])

function setupWatchers (map) {
  mapRef.value = map
  featureStore.bindMaplibreFeatureState({ map, source: 'parcellaire-operateur/data' })
  featureStore.bindMaplibreInteractions({ map, layer: 'parcellaire-operateur/geometry' })
}

function focusOnOriginalBbox () {
  zoomInto(featureStore.collection, { maxZoom: 12 })
}

function zoomInto (featureOrFeatureCollection, { maxZoom }) {
  const bounds = bbox(featureOrFeatureCollection)
  const { center, zoom, bearing } = mapRef.value.cameraForBounds(bounds, { padding: 50, maxZoom }) ?? {}
  if (center && zoom) {
    mapRef.value.flyTo({ center, zoom, bearing })
  }
}

function handleSetup (record) {
  recordStore.update(record)
}
</script>

<style>
.single-checkbox input[type="checkbox"] + label::before {
  left: auto !important;
  top: auto !important;
  margin: 0 !important;
}
.single-checkbox input[type="checkbox"] + label {
  margin: 0 !important;
}
</style>

<style scoped>
.fr-form-group[disabled="true"] {
  opacity: 0.5;
  pointer-events: none;
  cursor: default;
}
.fr-table {
  border-collapse: collapse;
  width: 100%;
}

.fr-table .tools {
  padding-left: 0;
  padding-right: 0;
}

  table .color-badge {
    background-color: var(--accent-color);
    display: inline-block;
    height: 14px;
    width: 14px;
  }

.rowIdCell small {
  font-weight: normal;
  margin-left: .5rem;
}

.fr-table td.numeric,
.fr-table th.numeric {
  font-variant-numeric: tabular-nums;
  text-align: right !important;
}

.culture-type,
.culture-group {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
  max-width: 350px;
}

.map {
  background: #ccc;
  height: min(100vh, 600px);
  position: relative;
}

.map--full-size {
  height: calc(90vh - 5rem);
}

.fr-col--map {
  position: relative;
}

.sticky-map {
  width: 100%;
  position: sticky;
  top: 2rem;
  z-index: var(--z-index-map);
}

.sticky-map--full-size {
  height: 90vh;
  z-index: var(--z-index-map-large)
}

.full-size-map {
  width: 180%;
  position: absolute;
  right: 0;
  background: #fff;
  height: 90vh;
}

.full-size-button {
  top: 0;
  left: 0;
  position: absolute;
  background: #fff;
}

.center-button {
  position: absolute;
  top: 0;
  right: 0;
  background: #fff;
}
</style>
