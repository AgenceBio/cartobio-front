<template>
  <div class="fr-container fr-my-5w">
    <h2 class="fr-h3">
      Sélectionner mon exploitation
    </h2>

    <form @submit.prevent="tryLogin" class="fr-search-bar fr-search-bar--lg" id="header-search" role="search">
      <label class="fr-label" for="search-784-input">
          Recherche
      </label>
      <input class="fr-input" placeholder="Rechercher" v-model="userLogin" ref="loginInput" required autofocustype="search" id="search-784-input">
      <button class="fr-btn" title="Rechercher" :disabled="isLoading">
        Rechercher
      </button>
    </form>

    <div class="fr-highlight help">
      <p>Par <span v-for="({ id, label }) in LOGIN_TYPES" :aria-selected="userLoginType.includes(id)" :key="id">
          {{ label }}
        </span>…
      </p>
    </div>

    <p v-if="candidateUsers.length" class="fr-my-3w">
      <button class="fr-link fr-icon-close-circle-line" @click="resetSearch">
        Annuler cette recherche
      </button>
    </p>

    <section class="fr-grid-row fr-grid-row--gutters" v-if="candidateUsers.length">
      <article class="fr-col-12 fr-col-md-4" v-for="candidateUser in candidateUsers" :key="candidateUser.id">
        <div class="fr-card fr-card--horizontal">
          <div class="fr-card__body">
              <div class="fr-card__content">
                  <h4 class="fr-card__title">{{ candidateUser.nom }}</h4>
                  <div class="fr-card__desc">
                    <ul>
                      <li v-if="candidateUser.denominationCourante && candidateUser.denominationCourante !== candidateUser.nom"><b>Dénomination courante</b> : {{ candidateUser.denominationCourante }}</li>
                      <li><b>SIRET</b> : {{ candidateUser.siret }}</li>
                      <li><b>PACAGE</b> : {{ candidateUser.numeroPacage }}</li>
                      <li><b>Numéro Bio</b> : {{ candidateUser.id }}</li>
                      <li><b>Date d'engagement</b> : {{ candidateUser.dateEngagement }}</li>
                    </ul>
                  </div>
                  <div class="fr-card__start">
                      <ul class="fr-tags-group">
                          <li>
                              <p class="fr-badge fr-badge--success fr-icon-medal-fill">vérifié</p>
                          </li>
                      </ul>
                  </div>
                </div>

                <div class="fr-card__footer">
                  <ul class="fr-btns-group  fr-btns-group--inline-lg">
                      <li>
                        <button class="fr-btn" @click.prevent="loginCandidateUser(candidateUser)">
                          Confirmer cette identité
                        </button>
                      </li>
                  </ul>
                </div>
          </div>
        </div>
      </article>
    </section>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import store from '../../store.js'

const router = useRouter()
const loginInput = ref(null)
const userLogin = ref('')
const cleanedInput = computed(() => userLogin.value.trim())
const cleanedInputWithoutSpaces = computed(() => userLogin.value.replace(/ /g, ''))

const isLoading = ref(false)
let candidateUsers = ref([])

const LOGIN_TYPES = [
  { id: 'name', label: "nom" },
  { id: 'siret', label: "SIRET" },
  // { id: 'email', label: "email" },
  { id: 'farm-name', label: "nom d’exploitation" },
  // { id: 'phone', label: "numéro de téléphone" },
  // { id: 'pacage', label: "numéro PACAGE" },
]

const userLoginType = computed(() => {
  //
  if (/^[0-9]{8,9}$/i.test(cleanedInputWithoutSpaces.value)) {
    return ['pacage']
  }
  //
  else if (/^[0-9]{14}$/i.test(cleanedInputWithoutSpaces.value)) {
    return ['siret']
  }
  // 0102030405
  // +33102030405
  // else if (/^[0-9]{10}$/i.test(cleanedInputWithoutSpaces) || /^\+[0-9]{2}[0-9]{9}$/i.test(cleanedInputWithoutSpaces)) {
  //   return ['phone']
  // }
  // via https://github.com/sindresorhus/email-regex/blob/main/index.js
  else if (new RegExp('^[^\\.\\s@:](?:[^\\s@:]*[^\\s@:\\.])?@[^\\.\\s@]+(?:\\.[^\\.\\s@]+)*$').test(cleanedInputWithoutSpaces.value)) {
    return ['email']
  }
  // arbitrary length… maybe not a great idea
  else if (cleanedInputWithoutSpaces.value.length > 3) {
    return ['name', 'farm-name']
  }

  return []
})


onMounted(() => loginInput.value?.focus())

function resetSearch () {
  candidateUsers.value = []
  userLogin.value = ''
  loginInput.value.focus()
  window._paq.push(['trackEvent', 'login', `search`, 'reset'])
}

async function tryLogin () {
  isLoading.value = true

  const userProfiles = await fetch(`${import.meta.env.VUE_APP_API_ENDPOINT}/v1/tryLogin`, {
    method: 'POST',
    body: JSON.stringify({ q: cleanedInput.value }),
    headers: {
      'Content-Type': 'application/json'
    }
  }).then(res => res.json())

  isLoading.value = false

  candidateUsers.value = userProfiles
  window._paq.push(['trackEvent', 'login', `search`, 'results'])
}

function loginCandidateUser (candidateUser) {
  window._paq.push(['trackEvent', 'login', `search`, 'selectOperator'])
  store.loginUser(candidateUser)
  router.push('/exploitation/certification-ab')
}
</script>

<style scoped>
span[aria-selected="true"] {
  font-weight: bold;
}

.help span:not(:last-of-type)::after {
  content: ", ";
}

dl.candidateUser {
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr 2fr;
  max-width: 640px;
}

  dl.candidateUser dt {
    font-weight: bold;
    text-align: right;
  }

  dl.candidateUser dd {
    margin: 0;
  }

</style>
