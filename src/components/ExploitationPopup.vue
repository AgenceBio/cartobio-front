<template>
  <MglPopup :showed="!hasOperator" :close-button="false" :offset="[0,-10]" :coordinates="coordinates" @open="onPopupOpened">
    <article class="exploitation">
      <h3 class="title mb-2">{{ properties.nom }}</h3>
      <h4 v-if="hasAlternateName" class="subheading grey--text text--darken-3 mb-2">{{ properties.identity.gerant }}</h4>

      <p v-if="properties.date_engagement"><v-chip small color="#b9d065">Engagement bio en {{ properties.date_engagement | dateFormat }}</v-chip></p>
      <p v-else><v-chip small color="grey lighten-2">Date d'engagement inconnue</v-chip></p>

      <v-divider />

      <p class="grey--text text--darken-3 pt-2 ma-0">Numéro Pacage : <b>{{ properties.pacage }}</b>.</p>
    </article>
  </MglPopup>
</template>

<script>
import {MglPopup} from "vue-mapbox"

export default {
  name: "ExploitationPopup",
  props: ['feature', 'operator'],

  components: {
    MglPopup
  },

  methods: {
    onPopupOpened ({ popup }) {
      popup.setMaxWidth('380px')
    }
  },

  filters: {
    dateFormat: (dateString) => new Date(dateString).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long'}),
  },

  computed: {
    properties () {
      return this.operator?.properties ?? { identity: {} }
    },

    coordinates () {
      return this.feature?.geometry.coordinates ?? [0, 0]
    },

    hasOperator () {
      return Boolean(this.feature && this.feature.id)
    },

    hasAlternateName () {
      return (
        this.properties?.nom &&
        // this line enables to discard accented chars and case sensitivity
        // with base, "a = A" and "à = A"
        this.properties?.nom.localeCompare(this.properties?.identity.gerant, 'fr', { sensitivity: "base" })
      ) ?? false
    }
  }
};
</script>

<style lang="scss" scoped>
$cell-padding: 10px;

.exploitation {
  width: 280px;
}

.v-chip {
  margin: 0;
}
</style>
